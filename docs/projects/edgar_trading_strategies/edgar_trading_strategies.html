<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Extracting and parsing data about insider trades on Forms 3, 4, and 5 from the SEC’s free public EDGAR API and testing a few trading strategies">

<title>Nicholas Burk - EDGAR Trading Strategies</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Nicholas Burk</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html" rel="" target="">
 <span class="menu-text">Projects</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introoverview" id="toc-introoverview" class="nav-link active" data-scroll-target="#introoverview">Intro/Overview</a></li>
  <li><a href="#setting-up" id="toc-setting-up" class="nav-link" data-scroll-target="#setting-up">Setting Up</a>
  <ul class="collapse">
  <li><a href="#loading-libraries" id="toc-loading-libraries" class="nav-link" data-scroll-target="#loading-libraries">Loading Libraries</a></li>
  <li><a href="#loading-sp500-price-data" id="toc-loading-sp500-price-data" class="nav-link" data-scroll-target="#loading-sp500-price-data">Loading S&amp;P500 Price Data</a></li>
  </ul></li>
  <li><a href="#edgar-data" id="toc-edgar-data" class="nav-link" data-scroll-target="#edgar-data">EDGAR Data</a>
  <ul class="collapse">
  <li><a href="#data-collection-functions" id="toc-data-collection-functions" class="nav-link" data-scroll-target="#data-collection-functions">Data Collection Functions</a></li>
  <li><a href="#data-collection-main-loop" id="toc-data-collection-main-loop" class="nav-link" data-scroll-target="#data-collection-main-loop">Data Collection Main Loop</a></li>
  <li><a href="#spot-check" id="toc-spot-check" class="nav-link" data-scroll-target="#spot-check">Spot Check</a></li>
  </ul></li>
  <li><a href="#trading-strategies" id="toc-trading-strategies" class="nav-link" data-scroll-target="#trading-strategies">Trading Strategies</a>
  <ul class="collapse">
  <li><a href="#feature-engineering" id="toc-feature-engineering" class="nav-link" data-scroll-target="#feature-engineering">Feature Engineering</a></li>
  <li><a href="#backtesting-engine" id="toc-backtesting-engine" class="nav-link" data-scroll-target="#backtesting-engine">Backtesting Engine</a></li>
  <li><a href="#hyperparameter-tuning" id="toc-hyperparameter-tuning" class="nav-link" data-scroll-target="#hyperparameter-tuning">Hyperparameter Tuning</a></li>
  <li><a href="#evaluate-performance" id="toc-evaluate-performance" class="nav-link" data-scroll-target="#evaluate-performance">Evaluate Performance</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">EDGAR Trading Strategies</h1>
</div>

<div>
  <div class="description">
    Extracting and parsing data about insider trades on Forms 3, 4, and 5 from the SEC’s free public EDGAR API and testing a few trading strategies
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="introoverview" class="level2">
<h2 class="anchored" data-anchor-id="introoverview">Intro/Overview</h2>
<p>Forms 3, 4, and 5 are critical filings with the U.S. Securities and Exchange Commission (SEC) that provide transparency into insider trading activities. They are mandated by Section 16 of the Securities Exchange Act of 1934 and apply to “insiders” of a company. For the purpose of these forms, an “insider” generally refers to:</p>
<ul>
<li><p>Officers: Executive officers (e.g., CEO, CFO, COO, General Counsel).</p></li>
<li><p>Directors: Members of the company’s board of directors.</p></li>
<li><p>Beneficial Owners: Any person or entity who owns more than 10% of any class of a company’s equity securities.</p></li>
</ul>
<p>These individuals have access to non-public information about the company, and the purpose of these filings is to prevent unfair use of that information and ensure market fairness. As such, information about the way they trade may provide valuable signals regarding future price movements of the relevant stock, if it is not already priced in by the time an individual trader can access it.</p>
</section>
<section id="setting-up" class="level2">
<h2 class="anchored" data-anchor-id="setting-up">Setting Up</h2>
<section id="loading-libraries" class="level3">
<h3 class="anchored" data-anchor-id="loading-libraries">Loading Libraries</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rvest)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(quantmod)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(runner)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="loading-sp500-price-data" class="level3">
<h3 class="anchored" data-anchor-id="loading-sp500-price-data">Loading S&amp;P500 Price Data</h3>
<p>For this example I will pick a few tickers from the S&amp;P500 to work with. There is no strong reason to focus on these specific companies; membership in the S&amp;P500 is just serving as a proxy for sufficient transaction volume for trading. Focusing on individual tradeable companies is important because getting the Form 3, 4, and 5 data from EDGAR is done at the company level, so the data collection is simplest when identifying specific companies of interest in advance.</p>
<p>The quantmod package contains a function called getSymbols() which lets the user pick one or more stock symbols and specify a time period, and then it downloads the relevant data from Yahoo Finance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pick a few tickers and download the data from Yahoo Finance</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>symbols_vec <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"SPY"</span>,<span class="st">"NVDA"</span>,<span class="st">"MSFT"</span>,<span class="st">"AMZN"</span>,<span class="st">"AAPL"</span>,<span class="st">"META"</span>,<span class="st">"AVGO"</span>,<span class="st">"GOOG"</span>,<span class="st">"GOOGL"</span>,<span class="st">"TSLA"</span>,<span class="st">"JPM"</span>,<span class="st">"WMT"</span>,<span class="st">"V"</span>,<span class="st">"LLY"</span>,<span class="st">"ORCL"</span>,<span class="st">"NFLX"</span>,<span class="st">"MA"</span>,<span class="st">"XOM"</span>,<span class="st">"COST"</span>,<span class="st">"PG"</span>,<span class="st">"JNJ"</span>,<span class="st">"HD"</span>,<span class="st">"BAC"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">getSymbols</span>(symbols_vec, <span class="at">from =</span> <span class="st">"2023-01-01"</span>, <span class="at">to =</span> <span class="st">"2024-12-31"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># combine adjusted close prices into one dataset</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># a bit weird because quantmod likes to return each ticker</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># as a new object in the environment</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>df_prices <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(symbols_vec)){</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># keep only the adjusted returns data</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  cmd <span class="ot">=</span> <span class="fu">paste0</span>(symbols_vec[i], <span class="st">"="</span>, symbols_vec[i], <span class="st">"[,grepl('Adjusted',colnames("</span>, symbols_vec[i], <span class="st">"))]"</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text =</span> cmd))</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># combine into one data frame</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    cmd <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"df_prices = "</span>, symbols_vec[i])</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text =</span> cmd))</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    cmd <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"df_prices = merge(df_prices, "</span>, symbols_vec[i], <span class="st">")"</span>)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text =</span> cmd))</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean up column names</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(df_prices) <span class="ot">=</span> <span class="fu">gsub</span>(<span class="st">".Adjusted"</span>, <span class="st">""</span>, <span class="fu">colnames</span>(df_prices))</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Add dates to adjusted close prices</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>df_prices <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">date =</span> <span class="fu">index</span>(df_prices), df_prices)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Write to file to avoid pulling every time</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(df_prices, <span class="st">"df_prices.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="co"># process price data</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>price_data_processed <span class="ot">=</span> df_prices <span class="sc">%&gt;%</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">ymd</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>date, <span class="at">names_to =</span> <span class="st">"ticker"</span>, <span class="at">values_to =</span> <span class="st">"close_price"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(close_price) <span class="sc">&amp;</span> close_price <span class="sc">&gt;</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is how the data looks after this initial cleanup.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(df_prices))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 5%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 2%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">date</th>
<th style="text-align: right;">SPY</th>
<th style="text-align: right;">NVDA</th>
<th style="text-align: right;">MSFT</th>
<th style="text-align: right;">AMZN</th>
<th style="text-align: right;">AAPL</th>
<th style="text-align: right;">META</th>
<th style="text-align: right;">AVGO</th>
<th style="text-align: right;">GOOG</th>
<th style="text-align: right;">GOOGL</th>
<th style="text-align: right;">TSLA</th>
<th style="text-align: right;">JPM</th>
<th style="text-align: right;">WMT</th>
<th style="text-align: right;">V</th>
<th style="text-align: right;">LLY</th>
<th style="text-align: right;">ORCL</th>
<th style="text-align: right;">NFLX</th>
<th style="text-align: right;">MA</th>
<th style="text-align: right;">XOM</th>
<th style="text-align: right;">COST</th>
<th style="text-align: right;">PG</th>
<th style="text-align: right;">JNJ</th>
<th style="text-align: right;">HD</th>
<th style="text-align: right;">BAC</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2023-01-03</td>
<td style="text-align: right;">368.1687</td>
<td style="text-align: right;">14.30229</td>
<td style="text-align: right;">234.8089</td>
<td style="text-align: right;">85.82</td>
<td style="text-align: right;">123.4706</td>
<td style="text-align: right;">124.0594</td>
<td style="text-align: right;">53.11102</td>
<td style="text-align: right;">89.16996</td>
<td style="text-align: right;">88.58871</td>
<td style="text-align: right;">108.10</td>
<td style="text-align: right;">126.1023</td>
<td style="text-align: right;">46.34946</td>
<td style="text-align: right;">203.5143</td>
<td style="text-align: right;">357.7304</td>
<td style="text-align: right;">80.98023</td>
<td style="text-align: right;">294.95</td>
<td style="text-align: right;">341.6681</td>
<td style="text-align: right;">97.81239</td>
<td style="text-align: right;">436.2654</td>
<td style="text-align: right;">142.4647</td>
<td style="text-align: right;">164.8901</td>
<td style="text-align: right;">296.2758</td>
<td style="text-align: right;">31.30841</td>
</tr>
<tr class="even">
<td style="text-align: left;">2023-01-04</td>
<td style="text-align: right;">371.0110</td>
<td style="text-align: right;">14.73590</td>
<td style="text-align: right;">224.5377</td>
<td style="text-align: right;">85.14</td>
<td style="text-align: right;">124.7441</td>
<td style="text-align: right;">126.6751</td>
<td style="text-align: right;">53.75969</td>
<td style="text-align: right;">88.18581</td>
<td style="text-align: right;">87.55491</td>
<td style="text-align: right;">113.64</td>
<td style="text-align: right;">127.2782</td>
<td style="text-align: right;">46.40110</td>
<td style="text-align: right;">208.6367</td>
<td style="text-align: right;">355.8781</td>
<td style="text-align: right;">81.71534</td>
<td style="text-align: right;">309.41</td>
<td style="text-align: right;">349.8946</td>
<td style="text-align: right;">98.09706</td>
<td style="text-align: right;">439.4222</td>
<td style="text-align: right;">143.0851</td>
<td style="text-align: right;">166.6853</td>
<td style="text-align: right;">299.8584</td>
<td style="text-align: right;">31.89703</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2023-01-05</td>
<td style="text-align: right;">366.7765</td>
<td style="text-align: right;">14.25233</td>
<td style="text-align: right;">217.8829</td>
<td style="text-align: right;">83.12</td>
<td style="text-align: right;">123.4212</td>
<td style="text-align: right;">126.2474</td>
<td style="text-align: right;">53.25879</td>
<td style="text-align: right;">86.25726</td>
<td style="text-align: right;">85.68610</td>
<td style="text-align: right;">110.34</td>
<td style="text-align: right;">127.2500</td>
<td style="text-align: right;">46.24295</td>
<td style="text-align: right;">207.1648</td>
<td style="text-align: right;">351.7812</td>
<td style="text-align: right;">81.55091</td>
<td style="text-align: right;">309.70</td>
<td style="text-align: right;">346.5645</td>
<td style="text-align: right;">100.29190</td>
<td style="text-align: right;">433.2914</td>
<td style="text-align: right;">141.3086</td>
<td style="text-align: right;">165.4546</td>
<td style="text-align: right;">295.8632</td>
<td style="text-align: right;">31.83162</td>
</tr>
<tr class="even">
<td style="text-align: left;">2023-01-06</td>
<td style="text-align: right;">375.1874</td>
<td style="text-align: right;">14.84580</td>
<td style="text-align: right;">220.4507</td>
<td style="text-align: right;">86.08</td>
<td style="text-align: right;">127.9624</td>
<td style="text-align: right;">129.3106</td>
<td style="text-align: right;">56.46476</td>
<td style="text-align: right;">87.63905</td>
<td style="text-align: right;">86.81931</td>
<td style="text-align: right;">113.06</td>
<td style="text-align: right;">129.6850</td>
<td style="text-align: right;">47.37585</td>
<td style="text-align: right;">213.6807</td>
<td style="text-align: right;">355.7212</td>
<td style="text-align: right;">82.85674</td>
<td style="text-align: right;">315.55</td>
<td style="text-align: right;">362.8172</td>
<td style="text-align: right;">101.50410</td>
<td style="text-align: right;">464.7447</td>
<td style="text-align: right;">144.6735</td>
<td style="text-align: right;">166.7963</td>
<td style="text-align: right;">297.7951</td>
<td style="text-align: right;">32.14929</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2023-01-09</td>
<td style="text-align: right;">374.9748</td>
<td style="text-align: right;">15.61412</td>
<td style="text-align: right;">222.5971</td>
<td style="text-align: right;">87.36</td>
<td style="text-align: right;">128.4856</td>
<td style="text-align: right;">128.7636</td>
<td style="text-align: right;">55.35740</td>
<td style="text-align: right;">88.27527</td>
<td style="text-align: right;">87.49525</td>
<td style="text-align: right;">119.77</td>
<td style="text-align: right;">129.1492</td>
<td style="text-align: right;">46.78520</td>
<td style="text-align: right;">214.5148</td>
<td style="text-align: right;">342.8719</td>
<td style="text-align: right;">83.90530</td>
<td style="text-align: right;">315.17</td>
<td style="text-align: right;">366.0736</td>
<td style="text-align: right;">99.61231</td>
<td style="text-align: right;">460.7793</td>
<td style="text-align: right;">142.9064</td>
<td style="text-align: right;">162.4749</td>
<td style="text-align: right;">298.0577</td>
<td style="text-align: right;">31.66345</td>
</tr>
<tr class="even">
<td style="text-align: left;">2023-01-10</td>
<td style="text-align: right;">377.6044</td>
<td style="text-align: right;">15.89487</td>
<td style="text-align: right;">224.2926</td>
<td style="text-align: right;">89.87</td>
<td style="text-align: right;">129.0582</td>
<td style="text-align: right;">132.2644</td>
<td style="text-align: right;">55.16933</td>
<td style="text-align: right;">88.71268</td>
<td style="text-align: right;">87.89288</td>
<td style="text-align: right;">118.85</td>
<td style="text-align: right;">130.3056</td>
<td style="text-align: right;">46.75615</td>
<td style="text-align: right;">216.9582</td>
<td style="text-align: right;">345.7339</td>
<td style="text-align: right;">83.98299</td>
<td style="text-align: right;">327.54</td>
<td style="text-align: right;">366.1131</td>
<td style="text-align: right;">101.10004</td>
<td style="text-align: right;">463.3298</td>
<td style="text-align: right;">142.7655</td>
<td style="text-align: right;">162.0863</td>
<td style="text-align: right;">300.7024</td>
<td style="text-align: right;">31.87834</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="edgar-data" class="level2">
<h2 class="anchored" data-anchor-id="edgar-data">EDGAR Data</h2>
<p>Accessing the EDGAR data through the free public API doesn’t require any setup. There is no need to register for an API key. As long as you provide a user agent in your request, you can get responses immediately. The tricky part is parsing the responses to get the data you want. The data for Forms 3, 4, 5 are .xml file types, but the content is html which is rendered in the browser. It makes it easy to review any individual form in the browser, but the formatting is not friendly for a script to parse. Here is a screenshot of a Form 4 filing as rendered in the browser as an example of what needs to be parsed:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="form4_example.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">https://www.sec.gov/Archives/edgar/data/354950/000035495023000043/xslF345X03/wf-form4_167727677966335.xml</figcaption>
</figure>
</div>
<section id="data-collection-functions" class="level3">
<h3 class="anchored" data-anchor-id="data-collection-functions">Data Collection Functions</h3>
<p>The first utility function gets the mapping from the EDGAR database of company ticker to Central Index Key (CIK), which is the unique 10-digit identifier assigned by the SEC to every individual, company, filing agent, or foreign government that files disclosure documents with the SEC. We need the CIK and not the ticker to find the correct information in EDGAR.</p>
<p>The second function uses the CIK we identified for a given ticker and finds all forms filed for that CIK, then filters the list to just the forms of interest (Forms 3, 4, 5). There are more forms available, but those are not of interest for this project.</p>
<p>The third function loops through the Form 3, 4, and 5 filings identified by the second function and tries to parse out the relevant information about the insider and the transactions they are reporting. This one is the most problematic because the forms are not identical and the html content is structured to be easy for a human to read in a browser but not for a computer to parse.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>USER_AGENT <span class="ot">=</span> <span class="st">"Your Name YourEmail@example.com"</span> <span class="co"># Required by EDGAR API</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>BASE_EDGAR_URL <span class="ot">=</span> <span class="st">"https://www.sec.gov/Archives/edgar/data/"</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Delay between API requests to respect rate limits (adjust as needed)</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>REQUEST_DELAY_SEC <span class="ot">=</span> <span class="dv">1</span> <span class="co"># 1 request per second</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get CIK identifier from EDGAR to match with tickers</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>get_cik_from_edgar <span class="ot">=</span> <span class="cf">function</span>() {</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">"Fetching CIK table from EDGAR</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  search_url <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"https://www.sec.gov/files/company_tickers.json"</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  response <span class="ot">=</span> <span class="fu">GET</span>(search_url, <span class="fu">add_headers</span>(<span class="st">`</span><span class="at">User-Agent</span><span class="st">`</span> <span class="ot">=</span> USER_AGENT))</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Sys.sleep</span>(REQUEST_DELAY_SEC) <span class="co"># Respect rate limit</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">http_error</span>(response)) {</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">"Failed to retrieve ticker data for CIK lookup. Status:"</span>, <span class="fu">status_code</span>(response)))</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  content <span class="ot">=</span> <span class="fu">content</span>(response, <span class="st">"text"</span>, <span class="at">encoding =</span> <span class="st">"UTF-8"</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  ticker_data <span class="ot">=</span> <span class="fu">fromJSON</span>(content)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Bind CIK information to data frame for output</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  cik_entries <span class="ot">=</span> <span class="fu">do.call</span>(<span class="st">'rbind'</span>, <span class="fu">lapply</span>(ticker_data, <span class="cf">function</span>(x){<span class="fu">as.data.frame</span>(x)}))</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  cik_entries<span class="sc">$</span>cik_str <span class="ot">=</span> <span class="fu">str_pad</span>(cik_entries<span class="sc">$</span>cik_str, <span class="at">width =</span> <span class="dv">10</span>, <span class="at">pad =</span> <span class="st">"0"</span>)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(cik_entries)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get recent filings for a CIK (using the company facts API for faster index lookup)</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>get_recent_filings <span class="ot">=</span> <span class="cf">function</span>(cik, <span class="at">form_types =</span> <span class="fu">c</span>(<span class="st">"3"</span>, <span class="st">"4"</span>, <span class="st">"5"</span>), start_date, end_date) {</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">"Fetching filings for CIK"</span>, cik, <span class="st">"between"</span>, start_date, <span class="st">"and"</span>, end_date, <span class="st">"...</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>  company_facts_url <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"https://data.sec.gov/submissions/CIK"</span>, cik, <span class="st">".json"</span>)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>  response <span class="ot">=</span> <span class="fu">GET</span>(company_facts_url, <span class="fu">add_headers</span>(<span class="st">`</span><span class="at">User-Agent</span><span class="st">`</span> <span class="ot">=</span> USER_AGENT))</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Sys.sleep</span>(REQUEST_DELAY_SEC) <span class="co"># Respect rate limit</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">http_error</span>(response)) {</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">"Failed to retrieve company facts for CIK"</span>, cik, <span class="st">". Status:"</span>, <span class="fu">status_code</span>(response)))</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>())</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>  content <span class="ot">=</span> <span class="fu">content</span>(response, <span class="st">"text"</span>, <span class="at">encoding =</span> <span class="st">"UTF-8"</span>)</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>  company_data <span class="ot">=</span> <span class="fu">fromJSON</span>(content)</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>  filings <span class="ot">=</span> company_data<span class="sc">$</span>filings<span class="sc">$</span>recent</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>  filings <span class="ot">=</span> <span class="fu">as.data.frame</span>(filings) <span class="co"># Convert list to data.frame</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(filings) <span class="sc">||</span> <span class="fu">nrow</span>(filings) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>())</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter by form type and date</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>  filtered_filings <span class="ot">=</span> filings <span class="sc">%&gt;%</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(form <span class="sc">%in%</span> form_types) <span class="sc">%&gt;%</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">filingDate =</span> <span class="fu">ymd</span>(filingDate)) <span class="sc">%&gt;%</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(filingDate <span class="sc">&gt;=</span> start_date <span class="sc">&amp;</span> filingDate <span class="sc">&lt;=</span> end_date)</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(filtered_filings) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"No relevant filings found for this CIK in the specified period.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>())</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Construct full URL to the XML document for parsing</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The primary document is usually the .xml file within the submission folder</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Path is typically /Archives/edgar/data/[CIK without leading zeros]/[accessionNumber without dashes]/[fileName]</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For Form 3/4/5, fileName is often [ticker]-[date].xml or [CIK]-[date].xml, or just ownership.xml</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This part is tricky and might need refinement based on actual filing structures.</span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>  filtered_filings <span class="ot">=</span> filtered_filings <span class="sc">%&gt;%</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>      <span class="at">accessionNumber_clean =</span> <span class="fu">str_replace_all</span>(accessionNumber, <span class="st">"-"</span>, <span class="st">""</span>),</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>      <span class="at">xml_url =</span> <span class="fu">paste0</span>(BASE_EDGAR_URL,</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">str_remove</span>(cik, <span class="st">"^0+"</span>), <span class="st">"/"</span>,</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>                       accessionNumber_clean, <span class="st">"/"</span>,</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>                       primaryDocument)</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(filtered_filings)</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to parse individual Form 3, 4, or 5 HTML filings (even if .xml extension)</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>parse_form_html <span class="ot">=</span> <span class="cf">function</span>(html_url) {</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">"Parsing HTML from:"</span>, html_url, <span class="st">"...</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>  response <span class="ot">=</span> <span class="fu">GET</span>(html_url, <span class="fu">add_headers</span>(<span class="st">`</span><span class="at">User-Agent</span><span class="st">`</span> <span class="ot">=</span> USER_AGENT))</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Sys.sleep</span>(REQUEST_DELAY_SEC) <span class="co"># Respect rate limit</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">http_error</span>(response)) {</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">"Failed to retrieve HTML from"</span>, html_url, <span class="st">". Status:"</span>, <span class="fu">status_code</span>(response)))</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>  html_content <span class="ot">=</span> <span class="fu">content</span>(response, <span class="st">"text"</span>, <span class="at">encoding =</span> <span class="st">"UTF-8"</span>)</span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use tryCatch for robust parsing with rvest::read_html</span></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>  parsed_html <span class="ot">=</span> <span class="fu">tryCatch</span>({</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">read_html</span>(html_content)</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">"Error parsing HTML from"</span>, html_url, <span class="st">":"</span>, e<span class="sc">$</span>message))</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(parsed_html)) {</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Extract relevant information using CSS selectors / XPath based on the provided HTML ---</span></span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reporting Owner Information</span></span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The reporting person's name is in an &lt;a&gt; tag within a table, followed by a &lt;hr&gt;</span></span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>  rpt_owner_name <span class="ot">&lt;-</span> parsed_html <span class="sc">%&gt;%</span></span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_element</span>(<span class="at">xpath =</span> <span class="st">"//table[contains(., 'Name and Address of Reporting Person')]/tr/td/table/tr/td/a"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_text</span>(<span class="at">trim =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The CIK for the reporting person is in the href attribute of the &lt;a&gt; tag</span></span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>  rpt_owner_cik <span class="ot">&lt;-</span> parsed_html <span class="sc">%&gt;%</span></span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_element</span>(<span class="at">xpath =</span> <span class="st">"//table[contains(., 'Name and Address of Reporting Person')]/tr/td/table/tr/td/a"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_attr</span>(<span class="st">"href"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_extract</span>(<span class="st">"CIK=([0-9]+)"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_replace</span>(<span class="st">"CIK="</span>, <span class="st">""</span>)</span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Issuer Information</span></span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Issuer name and ticker are in a specific table cell</span></span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>  issuer_info_node <span class="ot">&lt;-</span> parsed_html <span class="sc">%&gt;%</span></span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_element</span>(<span class="at">xpath =</span> <span class="st">"//td[contains(., 'Issuer Name')]/a"</span>)</span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>  issuer_name <span class="ot">&lt;-</span> issuer_info_node <span class="sc">%&gt;%</span> <span class="fu">html_text</span>(<span class="at">trim =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>  issuer_cik <span class="ot">&lt;-</span> issuer_info_node <span class="sc">%&gt;%</span></span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_attr</span>(<span class="st">"href"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_extract</span>(<span class="st">"CIK=([0-9]+)"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_replace</span>(<span class="st">"CIK="</span>, <span class="st">""</span>)</span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>  issuer_ticker <span class="ot">&lt;-</span> parsed_html <span class="sc">%&gt;%</span></span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_element</span>(<span class="at">xpath =</span> <span class="st">"//td[contains(., 'Issuer Name')]/span[@class='FormData']"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_text</span>(<span class="at">trim =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Relationship of Reporting Person(s) to Issuer (Checkboxes)</span></span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Look for "X" in the sibling &lt;td&gt; of the labels</span></span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a>  is_director <span class="ot">&lt;-</span> parsed_html <span class="sc">%&gt;%</span> <span class="fu">html_element</span>(<span class="at">xpath =</span> <span class="st">"//td[text()='Director']/preceding-sibling::td[1]"</span>) <span class="sc">%&gt;%</span> <span class="fu">html_text</span>(<span class="at">trim =</span> <span class="cn">TRUE</span>) <span class="sc">==</span> <span class="st">"X"</span></span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>  is_officer <span class="ot">&lt;-</span> parsed_html <span class="sc">%&gt;%</span> <span class="fu">html_element</span>(<span class="at">xpath =</span> <span class="st">"//td[text()='Officer (give title below)']/preceding-sibling::td[1]"</span>) <span class="sc">%&gt;%</span> <span class="fu">html_text</span>(<span class="at">trim =</span> <span class="cn">TRUE</span>) <span class="sc">==</span> <span class="st">"X"</span></span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>  is_ten_percent_owner <span class="ot">&lt;-</span> parsed_html <span class="sc">%&gt;%</span> <span class="fu">html_element</span>(<span class="at">xpath =</span> <span class="st">"//td[text()='10% Owner']/preceding-sibling::td[1]"</span>) <span class="sc">%&gt;%</span> <span class="fu">html_text</span>(<span class="at">trim =</span> <span class="cn">TRUE</span>) <span class="sc">==</span> <span class="st">"X"</span></span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a>  is_other <span class="ot">&lt;-</span> parsed_html <span class="sc">%&gt;%</span> <span class="fu">html_element</span>(<span class="at">xpath =</span> <span class="st">"//td[text()='Other (specify below)']/preceding-sibling::td[1]"</span>) <span class="sc">%&gt;%</span> <span class="fu">html_text</span>(<span class="at">trim =</span> <span class="cn">TRUE</span>) <span class="sc">==</span> <span class="st">"X"</span></span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Officer Title (if applicable)</span></span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a>  rpt_owner_title <span class="ot">&lt;-</span> parsed_html <span class="sc">%&gt;%</span></span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_element</span>(<span class="at">xpath =</span> <span class="st">"//td[text()='Officer (give title below)']/following-sibling::td[1]"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_text</span>(<span class="at">trim =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (is_officer <span class="sc">&amp;&amp;</span> rpt_owner_title <span class="sc">==</span> <span class="st">""</span>) {</span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sometimes title is next to "Officer" label itself if not a separate cell</span></span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a>    rpt_owner_title <span class="ot">&lt;-</span> parsed_html <span class="sc">%&gt;%</span></span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a>      <span class="fu">html_element</span>(<span class="at">xpath =</span> <span class="st">"//td[text()='Officer (give title below)']/parent::tr/following-sibling::tr/td[@style='color: blue']"</span>) <span class="sc">%&gt;%</span> <span class="co"># Check the blue text specifically</span></span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a>      <span class="fu">html_text</span>(<span class="at">trim =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean up if no title found or if it's just whitespace</span></span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(rpt_owner_title) <span class="sc">||</span> <span class="fu">trimws</span>(rpt_owner_title) <span class="sc">==</span> <span class="st">""</span>) {</span>
<span id="cb4-149"><a href="#cb4-149" aria-hidden="true" tabindex="-1"></a>    rpt_owner_title <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-152"><a href="#cb4-152" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Non-Derivative Transactions (Table I) ---</span></span>
<span id="cb4-153"><a href="#cb4-153" aria-hidden="true" tabindex="-1"></a>  transactions_list <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb4-154"><a href="#cb4-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-155"><a href="#cb4-155" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Identify "Table I"</span></span>
<span id="cb4-156"><a href="#cb4-156" aria-hidden="true" tabindex="-1"></a>  table_i_node <span class="ot">&lt;-</span> parsed_html <span class="sc">%&gt;%</span></span>
<span id="cb4-157"><a href="#cb4-157" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_element</span>(<span class="at">xpath =</span> <span class="st">"//table[.//b[contains(text(), 'Table I - Non-Derivative Securities')]]"</span>)</span>
<span id="cb4-158"><a href="#cb4-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-159"><a href="#cb4-159" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(table_i_node)) {</span>
<span id="cb4-160"><a href="#cb4-160" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract the table content as a data frame.</span></span>
<span id="cb4-161"><a href="#cb4-161" aria-hidden="true" tabindex="-1"></a>    <span class="co"># header = TRUE tells html_table to use the first meaningful rows as headers.</span></span>
<span id="cb4-162"><a href="#cb4-162" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fill = TRUE handles cases with merged cells or inconsistent row lengths by filling with NA.</span></span>
<span id="cb4-163"><a href="#cb4-163" aria-hidden="true" tabindex="-1"></a>    <span class="co"># trim = TRUE removes leading/trailing whitespace from cell values.</span></span>
<span id="cb4-164"><a href="#cb4-164" aria-hidden="true" tabindex="-1"></a>    <span class="co"># convert = FALSE to avoid automatic type conversion, we'll do it manually.</span></span>
<span id="cb4-165"><a href="#cb4-165" aria-hidden="true" tabindex="-1"></a>    non_derivative_data <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb4-166"><a href="#cb4-166" aria-hidden="true" tabindex="-1"></a>      <span class="fu">html_table</span>(table_i_node, <span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">fill =</span> <span class="cn">TRUE</span>, <span class="at">trim =</span> <span class="cn">TRUE</span>, <span class="at">convert =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-167"><a href="#cb4-167" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb4-168"><a href="#cb4-168" aria-hidden="true" tabindex="-1"></a>      <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">"Error extracting Table I:"</span>, e<span class="sc">$</span>message))</span>
<span id="cb4-169"><a href="#cb4-169" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb4-170"><a href="#cb4-170" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb4-171"><a href="#cb4-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-172"><a href="#cb4-172" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(non_derivative_data) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(non_derivative_data) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb4-173"><a href="#cb4-173" aria-hidden="true" tabindex="-1"></a>      <span class="co"># The table has a complex header with merged cells.</span></span>
<span id="cb4-174"><a href="#cb4-174" aria-hidden="true" tabindex="-1"></a>      <span class="co"># html_table with header=TRUE will likely combine the two header rows.</span></span>
<span id="cb4-175"><a href="#cb4-175" aria-hidden="true" tabindex="-1"></a>      <span class="co"># We need to manually fix column names and select relevant columns.</span></span>
<span id="cb4-176"><a href="#cb4-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-177"><a href="#cb4-177" aria-hidden="true" tabindex="-1"></a>      <span class="co"># This is where the forms start to differ</span></span>
<span id="cb4-178"><a href="#cb4-178" aria-hidden="true" tabindex="-1"></a>      <span class="co"># depending whether this is Form 3, 4, or 5</span></span>
<span id="cb4-179"><a href="#cb4-179" aria-hidden="true" tabindex="-1"></a>      <span class="co"># this table will have different columns</span></span>
<span id="cb4-180"><a href="#cb4-180" aria-hidden="true" tabindex="-1"></a>      <span class="co"># we will start with Table 4 as it is the most common and has the most columns</span></span>
<span id="cb4-181"><a href="#cb4-181" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (parsed_html <span class="sc">%&gt;%</span> <span class="fu">html_element</span>(<span class="at">xpath =</span> <span class="st">"//body"</span>) <span class="sc">%&gt;%</span> <span class="fu">html_text</span>(<span class="at">trim =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">substr</span>(<span class="dv">1</span>,<span class="dv">10</span>) <span class="sc">==</span> <span class="st">"SEC Form 4"</span>) {</span>
<span id="cb4-182"><a href="#cb4-182" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Rename columns to our desired standard names</span></span>
<span id="cb4-183"><a href="#cb4-183" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colnames</span>(non_derivative_data) <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb4-184"><a href="#cb4-184" aria-hidden="true" tabindex="-1"></a>          <span class="st">"securityTitle"</span>,</span>
<span id="cb4-185"><a href="#cb4-185" aria-hidden="true" tabindex="-1"></a>          <span class="st">"transactionDate"</span>,</span>
<span id="cb4-186"><a href="#cb4-186" aria-hidden="true" tabindex="-1"></a>          <span class="st">"deemedExecutionDate"</span>, <span class="co"># Keep this for now, though not always used</span></span>
<span id="cb4-187"><a href="#cb4-187" aria-hidden="true" tabindex="-1"></a>          <span class="st">"transactionCode"</span>,</span>
<span id="cb4-188"><a href="#cb4-188" aria-hidden="true" tabindex="-1"></a>          <span class="st">"vFlag"</span>,</span>
<span id="cb4-189"><a href="#cb4-189" aria-hidden="true" tabindex="-1"></a>          <span class="st">"sharesAcquiredDisposedAmount"</span>,</span>
<span id="cb4-190"><a href="#cb4-190" aria-hidden="true" tabindex="-1"></a>          <span class="st">"acquiredDisposedCode"</span>,</span>
<span id="cb4-191"><a href="#cb4-191" aria-hidden="true" tabindex="-1"></a>          <span class="st">"transactionPricePerShare"</span>,</span>
<span id="cb4-192"><a href="#cb4-192" aria-hidden="true" tabindex="-1"></a>          <span class="st">"postTransactionAmount"</span>,</span>
<span id="cb4-193"><a href="#cb4-193" aria-hidden="true" tabindex="-1"></a>          <span class="st">"directIndirectOwnership"</span>,</span>
<span id="cb4-194"><a href="#cb4-194" aria-hidden="true" tabindex="-1"></a>          <span class="st">"natureOfOwnership"</span></span>
<span id="cb4-195"><a href="#cb4-195" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-196"><a href="#cb4-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-197"><a href="#cb4-197" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove header rows that might be duplicated or empty due to `html_table` logic</span></span>
<span id="cb4-198"><a href="#cb4-198" aria-hidden="true" tabindex="-1"></a>        <span class="co"># and remove rows that are entirely NA (often occur due to merged cells or empty rows)</span></span>
<span id="cb4-199"><a href="#cb4-199" aria-hidden="true" tabindex="-1"></a>        non_derivative_data <span class="ot">&lt;-</span> non_derivative_data <span class="sc">%&gt;%</span></span>
<span id="cb4-200"><a href="#cb4-200" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">if_all</span>(<span class="fu">everything</span>(), is.na)) <span class="sc">%&gt;%</span> <span class="co"># Remove rows with all NAs</span></span>
<span id="cb4-201"><a href="#cb4-201" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">"Title of Security"</span>, securityTitle, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>))</span>
<span id="cb4-202"><a href="#cb4-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-203"><a href="#cb4-203" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process each row as a transaction or holding</span></span>
<span id="cb4-204"><a href="#cb4-204" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">nrow</span>(non_derivative_data) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb4-205"><a href="#cb4-205" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(non_derivative_data)) {</span>
<span id="cb4-206"><a href="#cb4-206" aria-hidden="true" tabindex="-1"></a>            row_data <span class="ot">&lt;-</span> non_derivative_data[i, ]</span>
<span id="cb4-207"><a href="#cb4-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-208"><a href="#cb4-208" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Determine if it's a transaction (has a transaction date/code) or a holding</span></span>
<span id="cb4-209"><a href="#cb4-209" aria-hidden="true" tabindex="-1"></a>            is_transaction <span class="ot">=</span> <span class="sc">!</span><span class="fu">is.na</span>(row_data<span class="sc">$</span>transactionDate) <span class="sc">&amp;&amp;</span> <span class="fu">trimws</span>(row_data<span class="sc">$</span>transactionDate) <span class="sc">!=</span> <span class="st">""</span> <span class="sc">&amp;&amp;</span></span>
<span id="cb4-210"><a href="#cb4-210" aria-hidden="true" tabindex="-1"></a>                             <span class="sc">!</span><span class="fu">is.na</span>(row_data<span class="sc">$</span>transactionCode) <span class="sc">&amp;&amp;</span> <span class="fu">trimws</span>(row_data<span class="sc">$</span>transactionCode) <span class="sc">!=</span> <span class="st">""</span></span>
<span id="cb4-211"><a href="#cb4-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-212"><a href="#cb4-212" aria-hidden="true" tabindex="-1"></a>            temp_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb4-213"><a href="#cb4-213" aria-hidden="true" tabindex="-1"></a>              <span class="at">transactionType =</span> <span class="fu">ifelse</span>(is_transaction, <span class="st">"Transaction"</span>, <span class="st">"Holding"</span>),</span>
<span id="cb4-214"><a href="#cb4-214" aria-hidden="true" tabindex="-1"></a>              <span class="at">securityTitle =</span> row_data<span class="sc">$</span>securityTitle,</span>
<span id="cb4-215"><a href="#cb4-215" aria-hidden="true" tabindex="-1"></a>              <span class="at">transactionDate =</span> <span class="fu">ifelse</span>(is_transaction, <span class="fu">as.character</span>(<span class="fu">mdy</span>(row_data<span class="sc">$</span>transactionDate)), <span class="cn">NA</span>),</span>
<span id="cb4-216"><a href="#cb4-216" aria-hidden="true" tabindex="-1"></a>              <span class="at">transactionFormType =</span> <span class="cn">NA</span>, <span class="co"># Not explicitly available in this table</span></span>
<span id="cb4-217"><a href="#cb4-217" aria-hidden="true" tabindex="-1"></a>              <span class="at">transactionCode =</span> row_data<span class="sc">$</span>transactionCode,</span>
<span id="cb4-218"><a href="#cb4-218" aria-hidden="true" tabindex="-1"></a>              <span class="at">equitySwapInvolved =</span> <span class="cn">NA</span>, <span class="co"># Not explicitly available in this table</span></span>
<span id="cb4-219"><a href="#cb4-219" aria-hidden="true" tabindex="-1"></a>              <span class="at">sharesAcquiredDisposed =</span> <span class="cn">NA</span>,</span>
<span id="cb4-220"><a href="#cb4-220" aria-hidden="true" tabindex="-1"></a>              <span class="at">transactionPricePerShare =</span> <span class="cn">NA</span>,</span>
<span id="cb4-221"><a href="#cb4-221" aria-hidden="true" tabindex="-1"></a>              <span class="at">directIndirectOwnership =</span> row_data<span class="sc">$</span>directIndirectOwnership,</span>
<span id="cb4-222"><a href="#cb4-222" aria-hidden="true" tabindex="-1"></a>              <span class="at">natureOfOwnership =</span> row_data<span class="sc">$</span>natureOfOwnership,</span>
<span id="cb4-223"><a href="#cb4-223" aria-hidden="true" tabindex="-1"></a>              <span class="at">postTransactionAmount =</span> <span class="cn">NA</span>,</span>
<span id="cb4-224"><a href="#cb4-224" aria-hidden="true" tabindex="-1"></a>              <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb4-225"><a href="#cb4-225" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb4-226"><a href="#cb4-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-227"><a href="#cb4-227" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Populate transaction specific fields only if it's a transaction</span></span>
<span id="cb4-228"><a href="#cb4-228" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (is_transaction) {</span>
<span id="cb4-229"><a href="#cb4-229" aria-hidden="true" tabindex="-1"></a>              <span class="co"># Handle shares acquired/disposed. The code (A)/(D) is in `acquiredDisposedCode`</span></span>
<span id="cb4-230"><a href="#cb4-230" aria-hidden="true" tabindex="-1"></a>              <span class="co"># And the amount is in `sharesAcquiredDisposedAmount`</span></span>
<span id="cb4-231"><a href="#cb4-231" aria-hidden="true" tabindex="-1"></a>              shares_val <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">",|</span><span class="sc">\\</span><span class="st">([^)]*</span><span class="sc">\\</span><span class="st">)"</span>, <span class="st">""</span>, row_data<span class="sc">$</span>sharesAcquiredDisposedAmount))</span>
<span id="cb4-232"><a href="#cb4-232" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> (row_data<span class="sc">$</span>acquiredDisposedCode <span class="sc">==</span> <span class="st">"D"</span>) {</span>
<span id="cb4-233"><a href="#cb4-233" aria-hidden="true" tabindex="-1"></a>                shares_val <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">abs</span>(shares_val) <span class="co"># Represent disposal as negative</span></span>
<span id="cb4-234"><a href="#cb4-234" aria-hidden="true" tabindex="-1"></a>              }</span>
<span id="cb4-235"><a href="#cb4-235" aria-hidden="true" tabindex="-1"></a>              temp_df<span class="sc">$</span>sharesAcquiredDisposed <span class="ot">&lt;-</span> shares_val</span>
<span id="cb4-236"><a href="#cb4-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-237"><a href="#cb4-237" aria-hidden="true" tabindex="-1"></a>              price_val <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">"[$,]|</span><span class="sc">\\</span><span class="st">([^)]*</span><span class="sc">\\</span><span class="st">)"</span>, <span class="st">""</span>, row_data<span class="sc">$</span>transactionPricePerShare))</span>
<span id="cb4-238"><a href="#cb4-238" aria-hidden="true" tabindex="-1"></a>              temp_df<span class="sc">$</span>transactionPricePerShare <span class="ot">&lt;-</span> price_val</span>
<span id="cb4-239"><a href="#cb4-239" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb4-240"><a href="#cb4-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-241"><a href="#cb4-241" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Post-transaction amount is relevant for both transactions and holdings</span></span>
<span id="cb4-242"><a href="#cb4-242" aria-hidden="true" tabindex="-1"></a>            temp_df<span class="sc">$</span>postTransactionAmount <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">",|</span><span class="sc">\\</span><span class="st">([^)]*</span><span class="sc">\\</span><span class="st">)"</span>, <span class="st">""</span>, row_data<span class="sc">$</span>postTransactionAmount))</span>
<span id="cb4-243"><a href="#cb4-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-244"><a href="#cb4-244" aria-hidden="true" tabindex="-1"></a>            transactions_list[[<span class="fu">length</span>(transactions_list) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> temp_df</span>
<span id="cb4-245"><a href="#cb4-245" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb4-246"><a href="#cb4-246" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-247"><a href="#cb4-247" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (parsed_html <span class="sc">%&gt;%</span> <span class="fu">html_element</span>(<span class="at">xpath =</span> <span class="st">"//body"</span>) <span class="sc">%&gt;%</span> <span class="fu">html_text</span>(<span class="at">trim =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">substr</span>(<span class="dv">1</span>,<span class="dv">10</span>) <span class="sc">==</span> <span class="st">"SEC Form 3"</span>) {</span>
<span id="cb4-248"><a href="#cb4-248" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Form 3 table is a lot like Form 4, which is why the parsing was identical up to here</span></span>
<span id="cb4-249"><a href="#cb4-249" aria-hidden="true" tabindex="-1"></a>        <span class="co"># but it doesn't contain transactions, just beneficial ownership information</span></span>
<span id="cb4-250"><a href="#cb4-250" aria-hidden="true" tabindex="-1"></a>        <span class="co"># so certain columns populated in Form 4 will always be NA here</span></span>
<span id="cb4-251"><a href="#cb4-251" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-252"><a href="#cb4-252" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Rename columns to our desired standard names</span></span>
<span id="cb4-253"><a href="#cb4-253" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colnames</span>(non_derivative_data) <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb4-254"><a href="#cb4-254" aria-hidden="true" tabindex="-1"></a>          <span class="st">"securityTitle"</span>,</span>
<span id="cb4-255"><a href="#cb4-255" aria-hidden="true" tabindex="-1"></a>          <span class="st">"postTransactionAmount"</span>,</span>
<span id="cb4-256"><a href="#cb4-256" aria-hidden="true" tabindex="-1"></a>          <span class="st">"directIndirectOwnership"</span>,</span>
<span id="cb4-257"><a href="#cb4-257" aria-hidden="true" tabindex="-1"></a>          <span class="st">"natureOfOwnership"</span></span>
<span id="cb4-258"><a href="#cb4-258" aria-hidden="true" tabindex="-1"></a>        )  </span>
<span id="cb4-259"><a href="#cb4-259" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb4-260"><a href="#cb4-260" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove header rows that might be duplicated or empty due to `html_table` logic</span></span>
<span id="cb4-261"><a href="#cb4-261" aria-hidden="true" tabindex="-1"></a>        <span class="co"># and remove rows that are entirely NA (often occur due to merged cells or empty rows)</span></span>
<span id="cb4-262"><a href="#cb4-262" aria-hidden="true" tabindex="-1"></a>        non_derivative_data <span class="ot">&lt;-</span> non_derivative_data <span class="sc">%&gt;%</span></span>
<span id="cb4-263"><a href="#cb4-263" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">if_all</span>(<span class="fu">everything</span>(), is.na)) <span class="sc">%&gt;%</span> <span class="co"># Remove rows with all NAs</span></span>
<span id="cb4-264"><a href="#cb4-264" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">"Title of Security"</span>, securityTitle, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>))</span>
<span id="cb4-265"><a href="#cb4-265" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-266"><a href="#cb4-266" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process each row as a holding, no transactions in Form 3</span></span>
<span id="cb4-267"><a href="#cb4-267" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">nrow</span>(non_derivative_data) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb4-268"><a href="#cb4-268" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(non_derivative_data)) {</span>
<span id="cb4-269"><a href="#cb4-269" aria-hidden="true" tabindex="-1"></a>            row_data <span class="ot">&lt;-</span> non_derivative_data[i, ]</span>
<span id="cb4-270"><a href="#cb4-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-271"><a href="#cb4-271" aria-hidden="true" tabindex="-1"></a>            temp_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb4-272"><a href="#cb4-272" aria-hidden="true" tabindex="-1"></a>              <span class="at">transactionType =</span> <span class="st">"Holding"</span>,</span>
<span id="cb4-273"><a href="#cb4-273" aria-hidden="true" tabindex="-1"></a>              <span class="at">securityTitle =</span> row_data<span class="sc">$</span>securityTitle,</span>
<span id="cb4-274"><a href="#cb4-274" aria-hidden="true" tabindex="-1"></a>              <span class="at">transactionDate =</span> parsed_html <span class="sc">%&gt;%</span> <span class="fu">html_element</span>(<span class="at">xpath =</span> <span class="st">"//span[contains(., 'Date of Event Requiring Statement')]/following-sibling::span"</span>) <span class="sc">%&gt;%</span> <span class="fu">html_text</span>(<span class="at">trim =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">mdy</span>() <span class="sc">%&gt;%</span> <span class="fu">as.character</span>(), <span class="co"># Can interpret date of reportable event as transaction date for holding</span></span>
<span id="cb4-275"><a href="#cb4-275" aria-hidden="true" tabindex="-1"></a>              <span class="at">transactionFormType =</span> <span class="cn">NA</span>, <span class="co"># Not applicable for Form 3</span></span>
<span id="cb4-276"><a href="#cb4-276" aria-hidden="true" tabindex="-1"></a>              <span class="at">transactionCode =</span> <span class="cn">NA</span>, <span class="co"># Not applicable for Form 3</span></span>
<span id="cb4-277"><a href="#cb4-277" aria-hidden="true" tabindex="-1"></a>              <span class="at">equitySwapInvolved =</span> <span class="cn">NA</span>, <span class="co"># Not applicable for Form 3</span></span>
<span id="cb4-278"><a href="#cb4-278" aria-hidden="true" tabindex="-1"></a>              <span class="at">sharesAcquiredDisposed =</span> <span class="cn">NA</span>, <span class="co"># Not applicable for Form 3</span></span>
<span id="cb4-279"><a href="#cb4-279" aria-hidden="true" tabindex="-1"></a>              <span class="at">transactionPricePerShare =</span> <span class="cn">NA</span>, <span class="co"># Not applicable for Form 3</span></span>
<span id="cb4-280"><a href="#cb4-280" aria-hidden="true" tabindex="-1"></a>              <span class="at">directIndirectOwnership =</span> row_data<span class="sc">$</span>directIndirectOwnership,</span>
<span id="cb4-281"><a href="#cb4-281" aria-hidden="true" tabindex="-1"></a>              <span class="at">natureOfOwnership =</span> row_data<span class="sc">$</span>natureOfOwnership,</span>
<span id="cb4-282"><a href="#cb4-282" aria-hidden="true" tabindex="-1"></a>              <span class="at">postTransactionAmount =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">",|</span><span class="sc">\\</span><span class="st">([^)]*</span><span class="sc">\\</span><span class="st">)"</span>, <span class="st">""</span>, row_data<span class="sc">$</span>postTransactionAmount)),</span>
<span id="cb4-283"><a href="#cb4-283" aria-hidden="true" tabindex="-1"></a>              <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb4-284"><a href="#cb4-284" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb4-285"><a href="#cb4-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-286"><a href="#cb4-286" aria-hidden="true" tabindex="-1"></a>            transactions_list[[<span class="fu">length</span>(transactions_list) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> temp_df</span>
<span id="cb4-287"><a href="#cb4-287" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb4-288"><a href="#cb4-288" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-289"><a href="#cb4-289" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (parsed_html <span class="sc">%&gt;%</span> <span class="fu">html_element</span>(<span class="at">xpath =</span> <span class="st">"//body"</span>) <span class="sc">%&gt;%</span> <span class="fu">html_text</span>(<span class="at">trim =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">substr</span>(<span class="dv">1</span>,<span class="dv">10</span>) <span class="sc">==</span> <span class="st">"SEC Form 5"</span>) {</span>
<span id="cb4-290"><a href="#cb4-290" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Form 5 table is a lot like Form 4, but for some reason parses as having 16 columns</span></span>
<span id="cb4-291"><a href="#cb4-291" aria-hidden="true" tabindex="-1"></a>        <span class="co"># even though it only has 10, so we need to drop the last 6 columns</span></span>
<span id="cb4-292"><a href="#cb4-292" aria-hidden="true" tabindex="-1"></a>        <span class="co"># also, one of the columns from the table in Form 4 is just not present here</span></span>
<span id="cb4-293"><a href="#cb4-293" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-294"><a href="#cb4-294" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Only keep first 10 columns, many duplicate columns are introduced</span></span>
<span id="cb4-295"><a href="#cb4-295" aria-hidden="true" tabindex="-1"></a>        <span class="co"># at the end for some reason</span></span>
<span id="cb4-296"><a href="#cb4-296" aria-hidden="true" tabindex="-1"></a>        non_derivative_data <span class="ot">=</span> non_derivative_data[,<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]  </span>
<span id="cb4-297"><a href="#cb4-297" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-298"><a href="#cb4-298" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Rename columns to our desired standard names</span></span>
<span id="cb4-299"><a href="#cb4-299" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colnames</span>(non_derivative_data) <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb4-300"><a href="#cb4-300" aria-hidden="true" tabindex="-1"></a>          <span class="st">"securityTitle"</span>,</span>
<span id="cb4-301"><a href="#cb4-301" aria-hidden="true" tabindex="-1"></a>          <span class="st">"transactionDate"</span>,</span>
<span id="cb4-302"><a href="#cb4-302" aria-hidden="true" tabindex="-1"></a>          <span class="st">"deemedExecutionDate"</span>,</span>
<span id="cb4-303"><a href="#cb4-303" aria-hidden="true" tabindex="-1"></a>          <span class="st">"transactionCode"</span>,</span>
<span id="cb4-304"><a href="#cb4-304" aria-hidden="true" tabindex="-1"></a>          <span class="co"># "vFlag", this is the one dropped in Form 5</span></span>
<span id="cb4-305"><a href="#cb4-305" aria-hidden="true" tabindex="-1"></a>          <span class="st">"sharesAcquiredDisposedAmount"</span>,</span>
<span id="cb4-306"><a href="#cb4-306" aria-hidden="true" tabindex="-1"></a>          <span class="st">"acquiredDisposedCode"</span>,</span>
<span id="cb4-307"><a href="#cb4-307" aria-hidden="true" tabindex="-1"></a>          <span class="st">"transactionPricePerShare"</span>,</span>
<span id="cb4-308"><a href="#cb4-308" aria-hidden="true" tabindex="-1"></a>          <span class="st">"postTransactionAmount"</span>,</span>
<span id="cb4-309"><a href="#cb4-309" aria-hidden="true" tabindex="-1"></a>          <span class="st">"directIndirectOwnership"</span>,</span>
<span id="cb4-310"><a href="#cb4-310" aria-hidden="true" tabindex="-1"></a>          <span class="st">"natureOfOwnership"</span></span>
<span id="cb4-311"><a href="#cb4-311" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-312"><a href="#cb4-312" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb4-313"><a href="#cb4-313" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove header rows that might be duplicated or empty due to `html_table` logic</span></span>
<span id="cb4-314"><a href="#cb4-314" aria-hidden="true" tabindex="-1"></a>        <span class="co"># and remove rows that are entirely NA (often occur due to merged cells or empty rows)</span></span>
<span id="cb4-315"><a href="#cb4-315" aria-hidden="true" tabindex="-1"></a>        non_derivative_data <span class="ot">&lt;-</span> non_derivative_data <span class="sc">%&gt;%</span></span>
<span id="cb4-316"><a href="#cb4-316" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">if_all</span>(<span class="fu">everything</span>(), is.na)) <span class="sc">%&gt;%</span> <span class="co"># Remove rows with all NAs</span></span>
<span id="cb4-317"><a href="#cb4-317" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">"Title of Security"</span>, securityTitle, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>))</span>
<span id="cb4-318"><a href="#cb4-318" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-319"><a href="#cb4-319" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process each row as a transaction or holding</span></span>
<span id="cb4-320"><a href="#cb4-320" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">nrow</span>(non_derivative_data) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb4-321"><a href="#cb4-321" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(non_derivative_data)) {</span>
<span id="cb4-322"><a href="#cb4-322" aria-hidden="true" tabindex="-1"></a>            row_data <span class="ot">&lt;-</span> non_derivative_data[i, ]</span>
<span id="cb4-323"><a href="#cb4-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-324"><a href="#cb4-324" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Determine if it's a transaction (has a transaction date/code) or a holding</span></span>
<span id="cb4-325"><a href="#cb4-325" aria-hidden="true" tabindex="-1"></a>            is_transaction <span class="ot">=</span> <span class="sc">!</span><span class="fu">is.na</span>(row_data<span class="sc">$</span>transactionDate) <span class="sc">&amp;&amp;</span> <span class="fu">trimws</span>(row_data<span class="sc">$</span>transactionDate) <span class="sc">!=</span> <span class="st">""</span> <span class="sc">&amp;&amp;</span></span>
<span id="cb4-326"><a href="#cb4-326" aria-hidden="true" tabindex="-1"></a>                             <span class="sc">!</span><span class="fu">is.na</span>(row_data<span class="sc">$</span>transactionCode) <span class="sc">&amp;&amp;</span> <span class="fu">trimws</span>(row_data<span class="sc">$</span>transactionCode) <span class="sc">!=</span> <span class="st">""</span></span>
<span id="cb4-327"><a href="#cb4-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-328"><a href="#cb4-328" aria-hidden="true" tabindex="-1"></a>            temp_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb4-329"><a href="#cb4-329" aria-hidden="true" tabindex="-1"></a>              <span class="at">transactionType =</span> <span class="fu">ifelse</span>(is_transaction, <span class="st">"Transaction"</span>, <span class="st">"Holding"</span>),</span>
<span id="cb4-330"><a href="#cb4-330" aria-hidden="true" tabindex="-1"></a>              <span class="at">securityTitle =</span> row_data<span class="sc">$</span>securityTitle,</span>
<span id="cb4-331"><a href="#cb4-331" aria-hidden="true" tabindex="-1"></a>              <span class="at">transactionDate =</span> <span class="fu">ifelse</span>(is_transaction, <span class="fu">as.character</span>(<span class="fu">mdy</span>(row_data<span class="sc">$</span>transactionDate)), <span class="cn">NA</span>),</span>
<span id="cb4-332"><a href="#cb4-332" aria-hidden="true" tabindex="-1"></a>              <span class="at">transactionFormType =</span> <span class="cn">NA</span>, <span class="co"># Not explicitly available in this table</span></span>
<span id="cb4-333"><a href="#cb4-333" aria-hidden="true" tabindex="-1"></a>              <span class="at">transactionCode =</span> row_data<span class="sc">$</span>transactionCode,</span>
<span id="cb4-334"><a href="#cb4-334" aria-hidden="true" tabindex="-1"></a>              <span class="at">equitySwapInvolved =</span> <span class="cn">NA</span>, <span class="co"># Not explicitly available in this table</span></span>
<span id="cb4-335"><a href="#cb4-335" aria-hidden="true" tabindex="-1"></a>              <span class="at">sharesAcquiredDisposed =</span> <span class="cn">NA</span>,</span>
<span id="cb4-336"><a href="#cb4-336" aria-hidden="true" tabindex="-1"></a>              <span class="at">transactionPricePerShare =</span> <span class="cn">NA</span>,</span>
<span id="cb4-337"><a href="#cb4-337" aria-hidden="true" tabindex="-1"></a>              <span class="at">directIndirectOwnership =</span> row_data<span class="sc">$</span>directIndirectOwnership,</span>
<span id="cb4-338"><a href="#cb4-338" aria-hidden="true" tabindex="-1"></a>              <span class="at">natureOfOwnership =</span> row_data<span class="sc">$</span>natureOfOwnership,</span>
<span id="cb4-339"><a href="#cb4-339" aria-hidden="true" tabindex="-1"></a>              <span class="at">postTransactionAmount =</span> <span class="cn">NA</span>,</span>
<span id="cb4-340"><a href="#cb4-340" aria-hidden="true" tabindex="-1"></a>              <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb4-341"><a href="#cb4-341" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb4-342"><a href="#cb4-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-343"><a href="#cb4-343" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Populate transaction specific fields only if it's a transaction</span></span>
<span id="cb4-344"><a href="#cb4-344" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (is_transaction) {</span>
<span id="cb4-345"><a href="#cb4-345" aria-hidden="true" tabindex="-1"></a>              <span class="co"># Handle shares acquired/disposed. The code (A)/(D) is in `acquiredDisposedCode`</span></span>
<span id="cb4-346"><a href="#cb4-346" aria-hidden="true" tabindex="-1"></a>              <span class="co"># And the amount is in `sharesAcquiredDisposedAmount`</span></span>
<span id="cb4-347"><a href="#cb4-347" aria-hidden="true" tabindex="-1"></a>              shares_val <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">",|</span><span class="sc">\\</span><span class="st">([^)]*</span><span class="sc">\\</span><span class="st">)"</span>, <span class="st">""</span>, row_data<span class="sc">$</span>sharesAcquiredDisposedAmount))</span>
<span id="cb4-348"><a href="#cb4-348" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> (row_data<span class="sc">$</span>acquiredDisposedCode <span class="sc">==</span> <span class="st">"D"</span>) {</span>
<span id="cb4-349"><a href="#cb4-349" aria-hidden="true" tabindex="-1"></a>                shares_val <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">abs</span>(shares_val) <span class="co"># Represent disposal as negative</span></span>
<span id="cb4-350"><a href="#cb4-350" aria-hidden="true" tabindex="-1"></a>              }</span>
<span id="cb4-351"><a href="#cb4-351" aria-hidden="true" tabindex="-1"></a>              temp_df<span class="sc">$</span>sharesAcquiredDisposed <span class="ot">&lt;-</span> shares_val</span>
<span id="cb4-352"><a href="#cb4-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-353"><a href="#cb4-353" aria-hidden="true" tabindex="-1"></a>              price_val <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">"[$,]|</span><span class="sc">\\</span><span class="st">([^)]*</span><span class="sc">\\</span><span class="st">)"</span>, <span class="st">""</span>, row_data<span class="sc">$</span>transactionPricePerShare))</span>
<span id="cb4-354"><a href="#cb4-354" aria-hidden="true" tabindex="-1"></a>              temp_df<span class="sc">$</span>transactionPricePerShare <span class="ot">&lt;-</span> price_val</span>
<span id="cb4-355"><a href="#cb4-355" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb4-356"><a href="#cb4-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-357"><a href="#cb4-357" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Post-transaction amount is relevant for both transactions and holdings</span></span>
<span id="cb4-358"><a href="#cb4-358" aria-hidden="true" tabindex="-1"></a>            temp_df<span class="sc">$</span>postTransactionAmount <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">",|</span><span class="sc">\\</span><span class="st">([^)]*</span><span class="sc">\\</span><span class="st">)"</span>, <span class="st">""</span>, row_data<span class="sc">$</span>postTransactionAmount))</span>
<span id="cb4-359"><a href="#cb4-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-360"><a href="#cb4-360" aria-hidden="true" tabindex="-1"></a>            transactions_list[[<span class="fu">length</span>(transactions_list) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> temp_df</span>
<span id="cb4-361"><a href="#cb4-361" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb4-362"><a href="#cb4-362" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-363"><a href="#cb4-363" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb4-364"><a href="#cb4-364" aria-hidden="true" tabindex="-1"></a>        <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">"Body in"</span>, html_url, <span class="st">"does not start with text SEC Form 3, 4, or 5."</span>))</span>
<span id="cb4-365"><a href="#cb4-365" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb4-366"><a href="#cb4-366" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-367"><a href="#cb4-367" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb4-368"><a href="#cb4-368" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">"Table I (Non-Derivative Securities) not found in"</span>, html_url))</span>
<span id="cb4-369"><a href="#cb4-369" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-370"><a href="#cb4-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-371"><a href="#cb4-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-372"><a href="#cb4-372" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Table II - Derivative Securities (Optional) ---</span></span>
<span id="cb4-373"><a href="#cb4-373" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This section would follow a similar logic to Table I if you need to extract derivative transactions.</span></span>
<span id="cb4-374"><a href="#cb4-374" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The XPath and column mapping would need to be adjusted for the derivative table's specific structure.</span></span>
<span id="cb4-375"><a href="#cb4-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-376"><a href="#cb4-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-377"><a href="#cb4-377" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(transactions_list) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb4-378"><a href="#cb4-378" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">"No identifiable non-derivative transaction or holding data found in"</span>, html_url))</span>
<span id="cb4-379"><a href="#cb4-379" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>) <span class="co"># No transactions found in this filing</span></span>
<span id="cb4-380"><a href="#cb4-380" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-381"><a href="#cb4-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-382"><a href="#cb4-382" aria-hidden="true" tabindex="-1"></a>  transactions_df <span class="ot">=</span> <span class="fu">bind_rows</span>(transactions_list) <span class="sc">%&gt;%</span></span>
<span id="cb4-383"><a href="#cb4-383" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure numeric columns are actually numeric</span></span>
<span id="cb4-384"><a href="#cb4-384" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(sharesAcquiredDisposed, transactionPricePerShare, postTransactionAmount), as.numeric))</span>
<span id="cb4-385"><a href="#cb4-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-386"><a href="#cb4-386" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add common filing details to each transaction row</span></span>
<span id="cb4-387"><a href="#cb4-387" aria-hidden="true" tabindex="-1"></a>  transactions_df<span class="sc">$</span>issuerName <span class="ot">=</span> issuer_name</span>
<span id="cb4-388"><a href="#cb4-388" aria-hidden="true" tabindex="-1"></a>  transactions_df<span class="sc">$</span>issuerCik <span class="ot">=</span> issuer_cik</span>
<span id="cb4-389"><a href="#cb4-389" aria-hidden="true" tabindex="-1"></a>  transactions_df<span class="sc">$</span>issuerTicker <span class="ot">=</span> issuer_ticker</span>
<span id="cb4-390"><a href="#cb4-390" aria-hidden="true" tabindex="-1"></a>  transactions_df<span class="sc">$</span>rptOwnerName <span class="ot">=</span> rpt_owner_name</span>
<span id="cb4-391"><a href="#cb4-391" aria-hidden="true" tabindex="-1"></a>  transactions_df<span class="sc">$</span>rptOwnerCik <span class="ot">=</span> rpt_owner_cik</span>
<span id="cb4-392"><a href="#cb4-392" aria-hidden="true" tabindex="-1"></a>  transactions_df<span class="sc">$</span>rptOfficerTitle <span class="ot">=</span> rpt_owner_title</span>
<span id="cb4-393"><a href="#cb4-393" aria-hidden="true" tabindex="-1"></a>  transactions_df<span class="sc">$</span>isDirector <span class="ot">=</span> is_director</span>
<span id="cb4-394"><a href="#cb4-394" aria-hidden="true" tabindex="-1"></a>  transactions_df<span class="sc">$</span>isOfficer <span class="ot">=</span> is_officer</span>
<span id="cb4-395"><a href="#cb4-395" aria-hidden="true" tabindex="-1"></a>  transactions_df<span class="sc">$</span>isTenPercentOwner <span class="ot">=</span> is_ten_percent_owner</span>
<span id="cb4-396"><a href="#cb4-396" aria-hidden="true" tabindex="-1"></a>  transactions_df<span class="sc">$</span>isOther <span class="ot">=</span> is_other</span>
<span id="cb4-397"><a href="#cb4-397" aria-hidden="true" tabindex="-1"></a>  transactions_df<span class="sc">$</span>filingUrl <span class="ot">=</span> html_url</span>
<span id="cb4-398"><a href="#cb4-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-399"><a href="#cb4-399" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(transactions_df)</span>
<span id="cb4-400"><a href="#cb4-400" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-collection-main-loop" class="level3">
<h3 class="anchored" data-anchor-id="data-collection-main-loop">Data Collection Main Loop</h3>
<p>Here we put together the utility functions above into a loop to collect all the desired data. We start with a list of tickers and a date range. For each ticker, we identify its associated CIK, get the list of related Form 3, 4, and 5 filings within the chosen date range, and then parse each filing into a data frame. At the end we combine all the parsed filing information into one large data frame for analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the mapping of tickers to CIK from EDGAR</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>cik_table <span class="ot">=</span> <span class="fu">get_cik_from_edgar</span>()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Collect EDGAR Form 3, 4, 5 data over the years 2023-2024</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>tickers    <span class="ot">=</span> symbols_vec[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>start_date <span class="ot">=</span> <span class="fu">ymd</span>(<span class="st">"2023-01-01"</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>end_date   <span class="ot">=</span> <span class="fu">ymd</span>(<span class="st">"2024-12-31"</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>all_insider_data <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>form_types_to_collect <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"3"</span>, <span class="st">"4"</span>, <span class="st">"5"</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (ticker <span class="cf">in</span> tickers) {</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  cik <span class="ot">=</span> cik_table[cik_table<span class="sc">$</span>ticker <span class="sc">==</span> ticker,]</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(cik) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">next</span> <span class="co"># Skip if CIK not found</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  cik <span class="ot">=</span> cik<span class="sc">$</span>cik_str[<span class="dv">1</span>]</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  filings <span class="ot">=</span> <span class="fu">get_recent_filings</span>(cik, form_types_to_collect, start_date, end_date)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(filings) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">next</span> <span class="co"># Skip if no relevant filings</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(filings)) {</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    filing_url <span class="ot">=</span> filings<span class="sc">$</span>xml_url[i]</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    parsed_data <span class="ot">=</span> <span class="fu">parse_form_html</span>(filing_url)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(parsed_data)) {</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>      parsed_data<span class="sc">$</span>filingDate <span class="ot">=</span> filings<span class="sc">$</span>filingDate[i]</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>      parsed_data<span class="sc">$</span>formType <span class="ot">=</span> filings<span class="sc">$</span>form[i]</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>      all_insider_data[[<span class="fu">length</span>(all_insider_data) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">=</span> parsed_data</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>raw_insider_data <span class="ot">=</span> <span class="fu">bind_rows</span>(all_insider_data)</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Save to disk to avoid re-downloading during development</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(raw_insider_data, <span class="st">"raw_insider_data.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="spot-check" class="level3">
<h3 class="anchored" data-anchor-id="spot-check">Spot Check</h3>
<p>Let’s take a quick look at the data that was collected.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print count of each type of form</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># each filing can consist of multiple holding</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># and transaction records, so count by unique filing</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>raw_insider_data <span class="sc">%&gt;%</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">duplicated</span>(filingUrl)) <span class="sc">%&gt;%</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(formType) <span class="sc">%&gt;%</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">formType</th>
<th style="text-align: right;">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">3</td>
<td style="text-align: right;">55</td>
</tr>
<tr class="even">
<td style="text-align: left;">4</td>
<td style="text-align: right;">3461</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5</td>
<td style="text-align: right;">14</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the first 5 rows for each type of form</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>raw_insider_data <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(formType) <span class="sc">%&gt;%</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 3%">
<col style="width: 5%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 3%">
<col style="width: 2%">
<col style="width: 5%">
<col style="width: 2%">
<col style="width: 1%">
<col style="width: 3%">
<col style="width: 1%">
<col style="width: 19%">
<col style="width: 2%">
<col style="width: 1%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">transactionType</th>
<th style="text-align: left;">securityTitle</th>
<th style="text-align: left;">transactionDate</th>
<th style="text-align: left;">transactionFormType</th>
<th style="text-align: left;">transactionCode</th>
<th style="text-align: left;">equitySwapInvolved</th>
<th style="text-align: right;">sharesAcquiredDisposed</th>
<th style="text-align: right;">transactionPricePerShare</th>
<th style="text-align: left;">directIndirectOwnership</th>
<th style="text-align: left;">natureOfOwnership</th>
<th style="text-align: right;">postTransactionAmount</th>
<th style="text-align: left;">issuerName</th>
<th style="text-align: left;">issuerCik</th>
<th style="text-align: left;">issuerTicker</th>
<th style="text-align: left;">rptOwnerName</th>
<th style="text-align: left;">rptOwnerCik</th>
<th style="text-align: left;">rptOfficerTitle</th>
<th style="text-align: left;">isDirector</th>
<th style="text-align: left;">isOfficer</th>
<th style="text-align: left;">isTenPercentOwner</th>
<th style="text-align: left;">isOther</th>
<th style="text-align: left;">filingUrl</th>
<th style="text-align: left;">filingDate</th>
<th style="text-align: left;">formType</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Holding</td>
<td style="text-align: left;">Common Stock</td>
<td style="text-align: left;">2023-07-31</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">D</td>
<td style="text-align: left;"></td>
<td style="text-align: right;">2614404.00</td>
<td style="text-align: left;">Serve Robotics Inc.&nbsp;/DE/</td>
<td style="text-align: left;">0001832483</td>
<td style="text-align: left;">SERV</td>
<td style="text-align: left;">NVIDIA CORP</td>
<td style="text-align: left;">0001045810</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">https://www.sec.gov/Archives/edgar/data/1045810/000104581024000231/xslF345X02/wk-form3_1721337425.xml</td>
<td style="text-align: left;">2024-07-18</td>
<td style="text-align: left;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">Holding</td>
<td style="text-align: left;">Common Stock</td>
<td style="text-align: left;">2023-12-07</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">D</td>
<td style="text-align: left;"></td>
<td style="text-align: right;">429.00</td>
<td style="text-align: left;">MICROSOFT CORP</td>
<td style="text-align: left;">0000789019</td>
<td style="text-align: left;">MSFT</td>
<td style="text-align: left;">Mason Mark</td>
<td style="text-align: left;">0001487290</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">https://www.sec.gov/Archives/edgar/data/789019/000106299323022250/xslF345X02/form3.xml</td>
<td style="text-align: left;">2023-12-08</td>
<td style="text-align: left;">3</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Holding</td>
<td style="text-align: left;">Common Stock</td>
<td style="text-align: left;">2023-12-07</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">D</td>
<td style="text-align: left;"></td>
<td style="text-align: right;">0.00</td>
<td style="text-align: left;">MICROSOFT CORP</td>
<td style="text-align: left;">0000789019</td>
<td style="text-align: left;">MSFT</td>
<td style="text-align: left;">MacGregor Catherine</td>
<td style="text-align: left;">0001415757</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">https://www.sec.gov/Archives/edgar/data/789019/000106299323022249/xslF345X02/form3.xml</td>
<td style="text-align: left;">2023-12-08</td>
<td style="text-align: left;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">Holding</td>
<td style="text-align: left;">Common Stock</td>
<td style="text-align: left;">2023-11-29</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">D</td>
<td style="text-align: left;"></td>
<td style="text-align: right;">49661.81</td>
<td style="text-align: left;">MICROSOFT CORP</td>
<td style="text-align: left;">0000789019</td>
<td style="text-align: left;">MSFT</td>
<td style="text-align: left;">Numoto Takeshi</td>
<td style="text-align: left;">0001899931</td>
<td style="text-align: left;">EVP, Chief Marketing Officer</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">https://www.sec.gov/Archives/edgar/data/789019/000106299323021742/xslF345X02/form3.xml</td>
<td style="text-align: left;">2023-12-01</td>
<td style="text-align: left;">3</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Holding</td>
<td style="text-align: left;">Class A Common Stock</td>
<td style="text-align: left;">2023-10-13</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">See Footnote(1)</td>
<td style="text-align: right;">12677398.00</td>
<td style="text-align: left;">PLAYSTUDIOS, Inc.</td>
<td style="text-align: left;">0001823878</td>
<td style="text-align: left;">MYPS</td>
<td style="text-align: left;">MICROSOFT CORP</td>
<td style="text-align: left;">0000789019</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">https://www.sec.gov/Archives/edgar/data/789019/000089924323020428/xslF345X02/doc3.xml</td>
<td style="text-align: left;">2023-11-17</td>
<td style="text-align: left;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">Transaction</td>
<td style="text-align: left;">Common Stock</td>
<td style="text-align: left;">2024-12-18</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">G</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">-385000</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">By Trust(4)</td>
<td style="text-align: right;">10275333.00</td>
<td style="text-align: left;">NVIDIA CORP</td>
<td style="text-align: left;">0001045810</td>
<td style="text-align: left;">NVDA</td>
<td style="text-align: left;">STEVENS MARK A</td>
<td style="text-align: left;">0001199039</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">https://www.sec.gov/Archives/edgar/data/1045810/000104581024000337/xslF345X05/wk-form4_1734736726.xml</td>
<td style="text-align: left;">2024-12-20</td>
<td style="text-align: left;">4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Holding</td>
<td style="text-align: left;">Common Stock</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">By the Envy Trust(5)</td>
<td style="text-align: right;">16070550.00</td>
<td style="text-align: left;">NVIDIA CORP</td>
<td style="text-align: left;">0001045810</td>
<td style="text-align: left;">NVDA</td>
<td style="text-align: left;">STEVENS MARK A</td>
<td style="text-align: left;">0001199039</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">https://www.sec.gov/Archives/edgar/data/1045810/000104581024000337/xslF345X05/wk-form4_1734736726.xml</td>
<td style="text-align: left;">2024-12-20</td>
<td style="text-align: left;">4</td>
</tr>
<tr class="even">
<td style="text-align: left;">Holding</td>
<td style="text-align: left;">Common Stock</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">D</td>
<td style="text-align: left;"></td>
<td style="text-align: right;">11541602.00</td>
<td style="text-align: left;">NVIDIA CORP</td>
<td style="text-align: left;">0001045810</td>
<td style="text-align: left;">NVDA</td>
<td style="text-align: left;">STEVENS MARK A</td>
<td style="text-align: left;">0001199039</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">https://www.sec.gov/Archives/edgar/data/1045810/000104581024000337/xslF345X05/wk-form4_1734736726.xml</td>
<td style="text-align: left;">2024-12-20</td>
<td style="text-align: left;">4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Transaction</td>
<td style="text-align: left;">Common</td>
<td style="text-align: left;">2024-12-16</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">S</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">-18591</td>
<td style="text-align: right;">132.6405</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">By Trust(2)</td>
<td style="text-align: right;">29652769.00</td>
<td style="text-align: left;">NVIDIA CORP</td>
<td style="text-align: left;">0001045810</td>
<td style="text-align: left;">NVDA</td>
<td style="text-align: left;">COXE TENCH</td>
<td style="text-align: left;">0001197647</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">https://www.sec.gov/Archives/edgar/data/1045810/000122520824010914/xslF345X05/doc4.xml</td>
<td style="text-align: left;">2024-12-18</td>
<td style="text-align: left;">4</td>
</tr>
<tr class="even">
<td style="text-align: left;">Transaction</td>
<td style="text-align: left;">Common</td>
<td style="text-align: left;">2024-12-16</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">S</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">-244176</td>
<td style="text-align: right;">131.8579</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">By Trust(2)</td>
<td style="text-align: right;">29408593.00</td>
<td style="text-align: left;">NVIDIA CORP</td>
<td style="text-align: left;">0001045810</td>
<td style="text-align: left;">NVDA</td>
<td style="text-align: left;">COXE TENCH</td>
<td style="text-align: left;">0001197647</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">https://www.sec.gov/Archives/edgar/data/1045810/000122520824010914/xslF345X05/doc4.xml</td>
<td style="text-align: left;">2024-12-18</td>
<td style="text-align: left;">4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Transaction</td>
<td style="text-align: left;">Common Stock</td>
<td style="text-align: left;">2024-04-18</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">W</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">42</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">By spouse(1)</td>
<td style="text-align: right;">6042.00</td>
<td style="text-align: left;">Apple Inc.</td>
<td style="text-align: left;">0000320193</td>
<td style="text-align: left;">AAPL</td>
<td style="text-align: left;">WAGNER SUSAN</td>
<td style="text-align: left;">0001059235</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">https://www.sec.gov/Archives/edgar/data/320193/000032019324000102/xslF345X05/wk-form5_1727822122.xml</td>
<td style="text-align: left;">2024-10-01</td>
<td style="text-align: left;">5</td>
</tr>
<tr class="even">
<td style="text-align: left;">Holding</td>
<td style="text-align: left;">Common Stock</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">D</td>
<td style="text-align: left;"></td>
<td style="text-align: right;">60975.00</td>
<td style="text-align: left;">Apple Inc.</td>
<td style="text-align: left;">0000320193</td>
<td style="text-align: left;">AAPL</td>
<td style="text-align: left;">WAGNER SUSAN</td>
<td style="text-align: left;">0001059235</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">https://www.sec.gov/Archives/edgar/data/320193/000032019324000102/xslF345X05/wk-form5_1727822122.xml</td>
<td style="text-align: left;">2024-10-01</td>
<td style="text-align: left;">5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Holding</td>
<td style="text-align: left;">Class C Capital Stock</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">D</td>
<td style="text-align: left;"></td>
<td style="text-align: right;">3480.00</td>
<td style="text-align: left;">Alphabet Inc.</td>
<td style="text-align: left;">0001652044</td>
<td style="text-align: left;">GOOG</td>
<td style="text-align: left;">CHAVEZ R. MARTIN</td>
<td style="text-align: left;">0001157983</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">https://www.sec.gov/Archives/edgar/data/1652044/000120919124003289/xslF345X05/doc5.xml</td>
<td style="text-align: left;">2024-02-13</td>
<td style="text-align: left;">5</td>
</tr>
<tr class="even">
<td style="text-align: left;">Holding</td>
<td style="text-align: left;">Class C Google Stock Units(2)</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">D</td>
<td style="text-align: left;"></td>
<td style="text-align: right;">2486.00</td>
<td style="text-align: left;">Alphabet Inc.</td>
<td style="text-align: left;">0001652044</td>
<td style="text-align: left;">GOOG</td>
<td style="text-align: left;">CHAVEZ R. MARTIN</td>
<td style="text-align: left;">0001157983</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">https://www.sec.gov/Archives/edgar/data/1652044/000120919124003289/xslF345X05/doc5.xml</td>
<td style="text-align: left;">2024-02-13</td>
<td style="text-align: left;">5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Holding</td>
<td style="text-align: left;">Class C Google Stock Units(3)</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">D</td>
<td style="text-align: left;"></td>
<td style="text-align: right;">5699.00</td>
<td style="text-align: left;">Alphabet Inc.</td>
<td style="text-align: left;">0001652044</td>
<td style="text-align: left;">GOOG</td>
<td style="text-align: left;">CHAVEZ R. MARTIN</td>
<td style="text-align: left;">0001157983</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">https://www.sec.gov/Archives/edgar/data/1652044/000120919124003289/xslF345X05/doc5.xml</td>
<td style="text-align: left;">2024-02-13</td>
<td style="text-align: left;">5</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We can see that the majority of the filings are Form 4 filings, there are only a few Form 3 or 5 filings in this data. If we look at rows 1 and 5 in the Form 3 data we printed out, it is interesting to see that rather than insiders being registered for Nvidia or Microsoft, we are seeing Nvidia and Microsoft acquire a stake of 10% or more in a different company. This is interesting information and might be leveraged for a trading strategy. For example, in recent time periods, companies that Nvidia invests in tend to be favored by market participants when they hear that news. For now, however, we focus on trading the tickers we already specified so these examples will need to be removed from the data.</p>
</section>
</section>
<section id="trading-strategies" class="level2">
<h2 class="anchored" data-anchor-id="trading-strategies">Trading Strategies</h2>
<p>Here are a few ideas for trading strategies that focus on the chosen tickers and leverage this EDGAR data:</p>
<ol type="1">
<li><strong>Multiple Bullish Executives:</strong> If several different executives choose to purchase the stock within a short enough time window, this may be a good indicator that the stock will do well over the near term.</li>
<li><strong>Buy/Sell Index of Insider Trades:</strong> Keep a running index of the total dollar value of insider buy/sell transactions. Buy when index is bullish (for example, twice as much buy volume as sell volume) or sell when the reverse occurs.</li>
<li><strong>Skin in the Game:</strong> A significant open-market purchase by a newly appointed key executive (like a CEO or CFO) signals strong confidence in the company’s future from the person with the newest top-level perspective. This would leverage the Form 3 data.</li>
</ol>
<section id="feature-engineering" class="level3">
<h3 class="anchored" data-anchor-id="feature-engineering">Feature Engineering</h3>
<p>Here we clean up the EDGAR data a little bit, and then use it to derive the necessary features for each of the three strategies outlines above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>tickers <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"NVDA"</span>,<span class="st">"MSFT"</span>,<span class="st">"AMZN"</span>,<span class="st">"AAPL"</span>,<span class="st">"META"</span>,<span class="st">"AVGO"</span>,<span class="st">"GOOG"</span>,<span class="st">"GOOGL"</span>,<span class="st">"TSLA"</span>,<span class="st">"JPM"</span>,<span class="st">"WMT"</span>,<span class="st">"V"</span>,<span class="st">"LLY"</span>,<span class="st">"ORCL"</span>,<span class="st">"NFLX"</span>,<span class="st">"MA"</span>,<span class="st">"XOM"</span>,<span class="st">"COST"</span>,<span class="st">"PG"</span>,<span class="st">"JNJ"</span>,<span class="st">"HD"</span>,<span class="st">"BAC"</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Preprocess EDGAR Data</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>edgar_data_processed <span class="ot">=</span> raw_insider_data <span class="sc">%&gt;%</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove cases where the company of interest is acquiring a stake in a different company</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(issuerTicker <span class="sc">%in%</span> tickers) <span class="sc">%&gt;%</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate transaction value. Handle cases where price is zero or NA.</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">transactionValue =</span> <span class="fu">ifelse</span>(transactionPricePerShare <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="fu">abs</span>(sharesAcquiredDisposed <span class="sc">*</span> transactionPricePerShare), <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Select relevant columns</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    filingDate, formType, issuerCik, issuerTicker, transactionCode, postTransactionAmount,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    transactionValue, rptOwnerCik, isDirector, isOfficer, isTenPercentOwner</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For simplicity, we'll use the issuerTicker as our main identifier</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">date =</span> filingDate, <span class="at">ticker =</span> issuerTicker) <span class="sc">%&gt;%</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ticker) <span class="sc">&amp;</span> ticker <span class="sc">!=</span> <span class="st">""</span>)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Split data into training (2023) and testing (2024) periods</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>train_start_date <span class="ot">=</span> <span class="fu">ymd</span>(<span class="st">"2023-01-01"</span>)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>train_end_date   <span class="ot">=</span> <span class="fu">ymd</span>(<span class="st">"2023-12-31"</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>test_start_date  <span class="ot">=</span> <span class="fu">ymd</span>(<span class="st">"2024-01-01"</span>)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>test_end_date    <span class="ot">=</span> <span class="fu">ymd</span>(<span class="st">"2024-12-31"</span>)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="co"># STRATEGY 1: Multiple Executive Buying</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>generate_strategy1_signals <span class="ot">&lt;-</span> <span class="cf">function</span>(data, <span class="at">exec_threshold =</span> <span class="dv">3</span>, <span class="at">window =</span> <span class="dv">30</span>, <span class="at">holding_period =</span> <span class="dv">90</span>, <span class="at">signal_delay =</span> <span class="dv">1</span>) {</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>  signals <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(transactionCode <span class="sc">==</span> <span class="st">'P'</span> <span class="sc">&amp;</span> (isOfficer <span class="sc">|</span> isDirector)) <span class="sc">%&gt;%</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(ticker, date) <span class="sc">%&gt;%</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(ticker) <span class="sc">%&gt;%</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">unique_buyers =</span> <span class="fu">runner</span>(</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> rptOwnerCik,</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">k =</span> <span class="fu">paste0</span>(window, <span class="st">" days"</span>),</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">idx =</span> date,</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">f =</span> <span class="cf">function</span>(x) <span class="fu">length</span>(<span class="fu">unique</span>(x))</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(unique_buyers <span class="sc">&gt;=</span> exec_threshold) <span class="sc">%&gt;%</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(ticker) <span class="sc">%&gt;%</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">days_since_last_signal =</span> date <span class="sc">-</span> <span class="fu">lag</span>(date, <span class="at">default =</span> <span class="fu">first</span>(date) <span class="sc">-</span> holding_period <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(days_since_last_signal <span class="sc">&gt;</span> holding_period) <span class="sc">%&gt;%</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># UPDATED: Add signal delay for trade execution</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transmute</span>(</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">entry_date =</span> date <span class="sc">+</span> <span class="fu">days</span>(signal_delay),</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">ticker =</span> ticker,</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">signal =</span> <span class="st">"BUY"</span>,</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">exit_date =</span> entry_date <span class="sc">+</span> <span class="fu">days</span>(holding_period)</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(signals)</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a><span class="co"># STRATEGY 2: Insider Buy/Sell Index</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>generate_strategy2_signals <span class="ot">&lt;-</span> <span class="cf">function</span>(data, <span class="at">lookback_period =</span> <span class="dv">90</span>, <span class="at">buy_threshold =</span> <span class="fl">2.0</span>, <span class="at">holding_period =</span> <span class="dv">90</span>, <span class="at">signal_delay =</span> <span class="dv">1</span>) {</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>  daily_volumes <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(transactionCode <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">'P'</span>, <span class="st">'S'</span>) <span class="sc">&amp;</span> transactionValue <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(ticker, date, transactionCode) <span class="sc">%&gt;%</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">totalValue =</span> <span class="fu">sum</span>(transactionValue), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">names_from =</span> transactionCode, <span class="at">values_from =</span> totalValue, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">buy_volume =</span> P, <span class="at">sell_volume =</span> S)</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>  index_data <span class="ot">&lt;-</span> daily_volumes <span class="sc">%&gt;%</span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(ticker, date) <span class="sc">%&gt;%</span></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(ticker) <span class="sc">%&gt;%</span></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>      <span class="at">rolling_buy =</span> <span class="fu">runner</span>(buy_volume, <span class="at">k =</span> <span class="fu">paste0</span>(lookback_period, <span class="st">" days"</span>), </span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>                           <span class="at">idx =</span> date, <span class="at">f =</span> sum, <span class="at">na_pad =</span> <span class="cn">TRUE</span>),</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>      <span class="at">rolling_sell =</span> <span class="fu">runner</span>(sell_volume, <span class="at">k =</span> <span class="fu">paste0</span>(lookback_period, <span class="st">" days"</span>), </span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>                            <span class="at">idx =</span> date, <span class="at">f =</span> sum, <span class="at">na_pad =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">buy_sell_index =</span> <span class="fu">ifelse</span>(rolling_sell <span class="sc">&gt;</span> <span class="dv">0</span>, rolling_buy <span class="sc">/</span> rolling_sell, rolling_buy)) <span class="sc">%&gt;%</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(date, ticker, buy_sell_index)</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>  buy_signals <span class="ot">&lt;-</span> index_data <span class="sc">%&gt;%</span></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(buy_sell_index <span class="sc">&gt;</span> buy_threshold) <span class="sc">%&gt;%</span></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(ticker) <span class="sc">%&gt;%</span></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(date <span class="sc">==</span> <span class="fu">min</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># UPDATED: Add signal delay for trade execution</span></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transmute</span>(</span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>      <span class="at">entry_date =</span> date <span class="sc">+</span> <span class="fu">days</span>(signal_delay),</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>      ticker,</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>      <span class="at">signal =</span> <span class="st">"BUY"</span>,</span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>      <span class="at">exit_date =</span> entry_date <span class="sc">+</span> <span class="fu">days</span>(holding_period)</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(buy_signals)</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a><span class="co"># STRATEGY 3: "Skin in the Game" (Form 3)</span></span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>generate_strategy3_signals <span class="ot">&lt;-</span> <span class="cf">function</span>(data, <span class="at">value_threshold =</span> <span class="dv">10000</span>, <span class="at">holding_period =</span> <span class="dv">180</span>, <span class="at">signal_delay =</span> <span class="dv">1</span>) {</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>  signals <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(formType <span class="sc">==</span> <span class="st">'3'</span> <span class="sc">&amp;</span> (isOfficer <span class="sc">|</span> isDirector)) <span class="sc">%&gt;%</span></span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(postTransactionAmount <span class="sc">&gt;=</span> value_threshold) <span class="sc">%&gt;%</span></span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(ticker) <span class="sc">%&gt;%</span></span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">days_since_last_signal =</span> date <span class="sc">-</span> <span class="fu">lag</span>(date, <span class="at">default =</span> <span class="fu">first</span>(date) <span class="sc">-</span> holding_period <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(days_since_last_signal <span class="sc">&gt;</span> holding_period) <span class="sc">%&gt;%</span></span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>    <span class="co"># UPDATED: Add signal delay for trade execution</span></span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transmute</span>(</span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>      <span class="at">entry_date =</span> date <span class="sc">+</span> <span class="fu">days</span>(signal_delay),</span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>      <span class="at">ticker =</span> ticker,</span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>      <span class="at">signal =</span> <span class="st">"BUY"</span>,</span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a>      <span class="at">exit_date =</span> entry_date <span class="sc">+</span> <span class="fu">days</span>(holding_period)</span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(signals)</span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="backtesting-engine" class="level3">
<h3 class="anchored" data-anchor-id="backtesting-engine">Backtesting Engine</h3>
<p>In order to evaluate these strategies, we need to combine the daily price data for our tickers with the entry and exit signals for each of the strategies. This function will handle the mechanics of entering and exiting positions for each of the strategies and keeping track of the portfolio value over time.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>run_backtest <span class="ot">&lt;-</span> <span class="cf">function</span>(signals, price_df, <span class="at">portfolio_alloc =</span> <span class="fl">0.1</span>, <span class="at">initial_capital =</span> <span class="dv">100000</span>) {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure signals are sorted by entry date</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  signals <span class="ot">&lt;-</span> signals <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(entry_date)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get all relevant dates for the simulation</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  trade_dates <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">c</span>(signals<span class="sc">$</span>entry_date, signals<span class="sc">$</span>exit_date))</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(trade_dates) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">date=</span><span class="fu">as.Date</span>(<span class="fu">character</span>()), <span class="at">portfolio_value=</span><span class="fu">numeric</span>()))</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  all_dates <span class="ot">&lt;-</span> price_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(date <span class="sc">&gt;=</span> <span class="fu">min</span>(trade_dates) <span class="sc">&amp;</span> date <span class="sc">&lt;=</span> <span class="fu">max</span>(trade_dates)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(date) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">sort</span>()</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(all_dates) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">date=</span><span class="fu">as.Date</span>(<span class="fu">character</span>()), <span class="at">portfolio_value=</span><span class="fu">numeric</span>()))</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  portfolio <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">date =</span> all_dates, <span class="at">portfolio_value =</span> initial_capital, <span class="at">cash =</span> initial_capital)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  active_positions <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">ticker =</span> <span class="fu">character</span>(), <span class="at">purchase_date =</span> <span class="fu">as.Date</span>(<span class="fu">character</span>()), <span class="at">shares =</span> <span class="fu">numeric</span>(), <span class="at">purchase_price =</span> <span class="fu">numeric</span>(), <span class="at">exit_date =</span> <span class="fu">as.Date</span>(<span class="fu">character</span>()))</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(all_dates)) {</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    current_date <span class="ot">&lt;-</span> all_dates[i]</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Carry over cash from previous day if not the first day</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (i <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>      portfolio<span class="sc">$</span>cash[i] <span class="ot">&lt;-</span> portfolio<span class="sc">$</span>cash[i<span class="dv">-1</span>]</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Exit positions whose exit_date is today or has passed</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    positions_to_exit <span class="ot">&lt;-</span> active_positions <span class="sc">%&gt;%</span> <span class="fu">filter</span>(exit_date <span class="sc">&lt;=</span> current_date)</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(positions_to_exit) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>      exit_prices <span class="ot">&lt;-</span> price_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(date <span class="sc">==</span> current_date <span class="sc">&amp;</span> ticker <span class="sc">%in%</span> positions_to_exit<span class="sc">$</span>ticker)</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">nrow</span>(exit_prices) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>        cash_inflow <span class="ot">&lt;-</span> positions_to_exit <span class="sc">%&gt;%</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>          <span class="fu">left_join</span>(exit_prices, <span class="at">by =</span> <span class="st">"ticker"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>          <span class="fu">summarise</span>(<span class="at">total_inflow =</span> <span class="fu">sum</span>(shares <span class="sc">*</span> close_price, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pull</span>(total_inflow)</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>        portfolio<span class="sc">$</span>cash[i] <span class="ot">&lt;-</span> portfolio<span class="sc">$</span>cash[i] <span class="sc">+</span> cash_inflow</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>        active_positions <span class="ot">&lt;-</span> <span class="fu">anti_join</span>(active_positions, positions_to_exit, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ticker"</span>, <span class="st">"purchase_date"</span>))</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Enter new positions scheduled for today</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    trades_today <span class="ot">&lt;-</span> signals <span class="sc">%&gt;%</span> <span class="fu">filter</span>(entry_date <span class="sc">==</span> current_date)</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(trades_today) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>      entry_prices <span class="ot">&lt;-</span> price_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(date <span class="sc">==</span> current_date <span class="sc">&amp;</span> ticker <span class="sc">%in%</span> trades_today<span class="sc">$</span>ticker)</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">nrow</span>(entry_prices) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>        trades_with_prices <span class="ot">&lt;-</span> trades_today <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(entry_prices, <span class="at">by =</span> <span class="st">"ticker"</span>)</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(trades_with_prices)) {</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>          trade <span class="ot">&lt;-</span> trades_with_prices[j, ]</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>          trade_cost <span class="ot">&lt;-</span> initial_capital <span class="sc">*</span> portfolio_alloc</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (portfolio<span class="sc">$</span>cash[i] <span class="sc">&gt;=</span> trade_cost <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(trade<span class="sc">$</span>close_price)) {</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>            portfolio<span class="sc">$</span>cash[i] <span class="ot">&lt;-</span> portfolio<span class="sc">$</span>cash[i] <span class="sc">-</span> trade_cost</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>            new_position <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>              <span class="at">ticker =</span> trade<span class="sc">$</span>ticker,</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>              <span class="at">purchase_date =</span> current_date,</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>              <span class="at">shares =</span> trade_cost <span class="sc">/</span> trade<span class="sc">$</span>close_price,</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>              <span class="at">purchase_price =</span> trade<span class="sc">$</span>close_price,</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>              <span class="at">exit_date =</span> trade<span class="sc">$</span>exit_date</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>            active_positions <span class="ot">&lt;-</span> <span class="fu">rbind</span>(active_positions, new_position)</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update total portfolio value based on current prices of active positions</span></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(active_positions) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>      current_prices <span class="ot">&lt;-</span> price_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(date <span class="sc">==</span> current_date <span class="sc">&amp;</span> ticker <span class="sc">%in%</span> active_positions<span class="sc">$</span>ticker)</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>      holdings_value <span class="ot">&lt;-</span> active_positions <span class="sc">%&gt;%</span></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>        <span class="fu">left_join</span>(current_prices, <span class="at">by =</span> <span class="st">"ticker"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If price is missing for today (e.g., non-trading day), use last known purchase price</span></span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">current_price =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(close_price), purchase_price, close_price)) <span class="sc">%&gt;%</span></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(<span class="at">total_value =</span> <span class="fu">sum</span>(shares <span class="sc">*</span> current_price)) <span class="sc">%&gt;%</span></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pull</span>(total_value)</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>      holdings_value <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>    portfolio<span class="sc">$</span>portfolio_value[i] <span class="ot">&lt;-</span> portfolio<span class="sc">$</span>cash[i] <span class="sc">+</span> holdings_value</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(portfolio)</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="hyperparameter-tuning" class="level3">
<h3 class="anchored" data-anchor-id="hyperparameter-tuning">Hyperparameter Tuning</h3>
<p>There are several parameters that we can change for each of the strategies, such as the lookback window, the holding period, etc. We will use the 2023 data as the training data for tuning these parameters to determine the best settings, then evaluate the performance of the strategies under those tuned parameters one the remaining data from 2024.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define data for the training period</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> edgar_data_processed <span class="sc">%&gt;%</span> <span class="fu">filter</span>(date <span class="sc">&gt;=</span> train_start_date <span class="sc">&amp;</span> date <span class="sc">&lt;=</span> train_end_date)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>train_prices <span class="ot">&lt;-</span> price_data_processed <span class="sc">%&gt;%</span> <span class="fu">filter</span>(date <span class="sc">&gt;=</span> train_start_date <span class="sc">&amp;</span> date <span class="sc">&lt;=</span> train_end_date)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Strategy 1 Tuning</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>s1_params <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">exec_threshold =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>),</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">window =</span> <span class="fu">c</span>(<span class="dv">7</span>, <span class="dv">14</span>, <span class="dv">30</span>),</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">holding_period =</span> <span class="fu">c</span>(<span class="dv">60</span>, <span class="dv">90</span>),</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">signal_delay =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">7</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>s1_results <span class="ot">&lt;-</span> s1_params <span class="sc">%&gt;%</span> </span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">signals =</span> <span class="fu">pmap</span>(<span class="fu">list</span>(exec_threshold, window, holding_period, signal_delay), <span class="sc">~</span><span class="fu">generate_strategy1_signals</span>(train_data, ..<span class="dv">1</span>, ..<span class="dv">2</span>, ..<span class="dv">3</span>, ..<span class="dv">4</span>)),</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">backtest =</span> <span class="fu">map</span>(signals, <span class="sc">~</span><span class="fu">run_backtest</span>(., train_prices)),</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">final_value =</span> <span class="fu">map_dbl</span>(backtest, <span class="sc">~</span><span class="cf">if</span>(<span class="fu">nrow</span>(.) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">tail</span>(.<span class="sc">$</span>portfolio_value, <span class="dv">1</span>) <span class="cf">else</span> <span class="dv">100000</span>)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(final_value))</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>best_s1_params <span class="ot">&lt;-</span> s1_results[<span class="dv">1</span>, ]</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Print top parameters for Strategy 1</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(<span class="fu">select</span>(s1_results, exec_threshold, window, holding_period, signal_delay, final_value)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">exec_threshold</th>
<th style="text-align: right;">window</th>
<th style="text-align: right;">holding_period</th>
<th style="text-align: right;">signal_delay</th>
<th style="text-align: right;">final_value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">103809.8</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">103809.8</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">103799.4</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">103799.4</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">103783.5</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">103783.5</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Strategy 2 Tuning</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>s2_params <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">lookback_period =</span> <span class="fu">c</span>(<span class="dv">7</span>, <span class="dv">30</span>, <span class="dv">60</span>, <span class="dv">90</span>),</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">buy_threshold =</span> <span class="fu">c</span>(<span class="fl">2.0</span>, <span class="fl">3.0</span>, <span class="fl">4.0</span>),</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">holding_period =</span> <span class="fu">c</span>(<span class="dv">60</span>, <span class="dv">90</span>),</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">signal_delay =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">7</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>s2_results <span class="ot">&lt;-</span> s2_params <span class="sc">%&gt;%</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">signals =</span> <span class="fu">pmap</span>(<span class="fu">list</span>(lookback_period, buy_threshold, holding_period, signal_delay), <span class="sc">~</span><span class="fu">generate_strategy2_signals</span>(train_data, ..<span class="dv">1</span>, ..<span class="dv">2</span>, ..<span class="dv">3</span>, ..<span class="dv">4</span>)),</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">backtest =</span> <span class="fu">map</span>(signals, <span class="sc">~</span><span class="fu">run_backtest</span>(., train_prices)),</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">final_value =</span> <span class="fu">map_dbl</span>(backtest, <span class="sc">~</span><span class="cf">if</span>(<span class="fu">nrow</span>(.) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">tail</span>(.<span class="sc">$</span>portfolio_value, <span class="dv">1</span>) <span class="cf">else</span> <span class="dv">100000</span>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(final_value))</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>best_s2_params <span class="ot">&lt;-</span> s2_results[<span class="dv">1</span>, ]</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Print top parameters for Strategy 2</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(<span class="fu">select</span>(s2_results, lookback_period, buy_threshold, holding_period, signal_delay, final_value)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 22%">
<col style="width: 20%">
<col style="width: 21%">
<col style="width: 18%">
<col style="width: 17%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">lookback_period</th>
<th style="text-align: right;">buy_threshold</th>
<th style="text-align: right;">holding_period</th>
<th style="text-align: right;">signal_delay</th>
<th style="text-align: right;">final_value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">90</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">103389.0</td>
</tr>
<tr class="even">
<td style="text-align: right;">90</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">103389.0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">90</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">103389.0</td>
</tr>
<tr class="even">
<td style="text-align: right;">90</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">103005.3</td>
</tr>
<tr class="odd">
<td style="text-align: right;">90</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">103005.3</td>
</tr>
<tr class="even">
<td style="text-align: right;">90</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">103005.3</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Strategy 3 Tuning</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>s3_params <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">value_threshold =</span> <span class="fu">c</span>(<span class="dv">1000</span>, <span class="dv">10000</span>, <span class="dv">100000</span>),</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">holding_period =</span> <span class="fu">c</span>(<span class="dv">120</span>, <span class="dv">150</span>, <span class="dv">180</span>),</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">signal_delay =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">7</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>s3_results <span class="ot">&lt;-</span> s3_params <span class="sc">%&gt;%</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">signals =</span> <span class="fu">pmap</span>(<span class="fu">list</span>(value_threshold, holding_period, signal_delay), <span class="sc">~</span><span class="fu">generate_strategy3_signals</span>(train_data, ..<span class="dv">1</span>, ..<span class="dv">2</span>, ..<span class="dv">3</span>)),</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">backtest =</span> <span class="fu">map</span>(signals, <span class="sc">~</span><span class="fu">run_backtest</span>(., train_prices)),</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">final_value =</span> <span class="fu">map_dbl</span>(backtest, <span class="sc">~</span><span class="cf">if</span>(<span class="fu">nrow</span>(.) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">tail</span>(.<span class="sc">$</span>portfolio_value, <span class="dv">1</span>) <span class="cf">else</span> <span class="dv">100000</span>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(final_value))</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>best_s3_params <span class="ot">&lt;-</span> s3_results[<span class="dv">1</span>, ]</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Print top parameters for Strategy 3</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(<span class="fu">select</span>(s3_results, value_threshold, holding_period, signal_delay, final_value)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">value_threshold</th>
<th style="text-align: right;">holding_period</th>
<th style="text-align: right;">signal_delay</th>
<th style="text-align: right;">final_value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1000</td>
<td style="text-align: right;">150</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">113184.9</td>
</tr>
<tr class="even">
<td style="text-align: right;">1000</td>
<td style="text-align: right;">180</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">113030.7</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1000</td>
<td style="text-align: right;">180</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">111831.8</td>
</tr>
<tr class="even">
<td style="text-align: right;">1000</td>
<td style="text-align: right;">180</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">111714.5</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1000</td>
<td style="text-align: right;">150</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110623.0</td>
</tr>
<tr class="even">
<td style="text-align: right;">1000</td>
<td style="text-align: right;">150</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">110172.4</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The signal_delay parameter is incorporated into all of these strategies represents the number of days after the form’s filing date that we will trigger the entry flag to enter into the position. This is set to 1 by default since we might not receive data for a form until after the market closes that day. For example, if an insider files Form 4 at end of day January 4, even if we are constantly requesting form data from EDGAR we won’t be able to act on it on January 4 because the market will already be closed that day, so the earliest we can enter the position is January 5.</p>
<p>In this tuning section, we evaluate signal delays of 1, 2, and 7 days as a way to check how robust the strategies are to late entry. Or to say it differently, is the market so sensitive to this information that entering the position as fast as possible is critical to profitability? We can see from the parameter optimization results above that this is not the case. Many of the top parameter combinations have different values for the signal delay parameter, showing that changing the value of this parameter does not result in significant changes in profitability.</p>
</section>
<section id="evaluate-performance" class="level3">
<h3 class="anchored" data-anchor-id="evaluate-performance">Evaluate Performance</h3>
<p>Having identified the best hyperparameter settings for each strategy, we can now test the trained strategies over the holdout data from 2024 to see how well they perform. For this evaluation, it is useful to also include the S&amp;P500 index as a benchmark. Even if the strategies perform well, in order to provide meaningful values they should be able to outperform a simple strategy of buying and holding an S&amp;P500 ETF such as SPY over the evaluation period.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define data for the testing period</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> edgar_data_processed <span class="sc">%&gt;%</span> <span class="fu">filter</span>(date <span class="sc">&gt;=</span> test_start_date <span class="sc">&amp;</span> date <span class="sc">&lt;=</span> test_end_date)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>test_prices <span class="ot">&lt;-</span> price_data_processed <span class="sc">%&gt;%</span> <span class="fu">filter</span>(date <span class="sc">&gt;=</span> test_start_date <span class="sc">&amp;</span> date <span class="sc">&lt;=</span> test_end_date)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate Strategy 1</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>s1_test_signals <span class="ot">&lt;-</span> <span class="fu">generate_strategy1_signals</span>(test_data, best_s1_params<span class="sc">$</span>exec_threshold, best_s1_params<span class="sc">$</span>window, best_s1_params<span class="sc">$</span>holding_period)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>s1_test_performance <span class="ot">&lt;-</span> <span class="fu">run_backtest</span>(s1_test_signals, test_prices)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>s1_final_value <span class="ot">&lt;-</span> <span class="fu">tail</span>(s1_test_performance<span class="sc">$</span>portfolio_value, <span class="dv">1</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Strategy 1 Final Portfolio Value (2024): $%.2f</span><span class="sc">\n</span><span class="st">"</span>, s1_final_value))</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate Strategy 2</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>s2_test_signals <span class="ot">&lt;-</span> <span class="fu">generate_strategy2_signals</span>(test_data, best_s2_params<span class="sc">$</span>lookback_period, best_s2_params<span class="sc">$</span>buy_threshold, <span class="at">holding_period =</span> best_s2_params<span class="sc">$</span>holding_period)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>s2_test_performance <span class="ot">&lt;-</span> <span class="fu">run_backtest</span>(s2_test_signals, test_prices)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>s2_final_value <span class="ot">&lt;-</span> <span class="fu">tail</span>(s2_test_performance<span class="sc">$</span>portfolio_value, <span class="dv">1</span>)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Strategy 2 Final Portfolio Value (2024): $%.2f</span><span class="sc">\n</span><span class="st">"</span>, s2_final_value))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Strategy 2 Final Portfolio Value (2024): $100333.70</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate Strategy 3</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>s3_test_signals <span class="ot">&lt;-</span> <span class="fu">generate_strategy3_signals</span>(test_data, best_s3_params<span class="sc">$</span>value_threshold, best_s3_params<span class="sc">$</span>holding_period)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>s3_test_performance <span class="ot">&lt;-</span> <span class="fu">run_backtest</span>(s3_test_signals, test_prices)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>s3_final_value <span class="ot">&lt;-</span> <span class="fu">tail</span>(s3_test_performance<span class="sc">$</span>portfolio_value, <span class="dv">1</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Strategy 3 Final Portfolio Value (2024): $%.2f</span><span class="sc">\n</span><span class="st">"</span>, s3_final_value))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Strategy 3 Final Portfolio Value (2024): $106324.03</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate Strategy 4: Benchmark of just buying and holding SPY</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>s4_test_signals <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">entry_date =</span> <span class="fu">as.Date</span>(<span class="st">"2024-01-04"</span>), <span class="at">ticker =</span> <span class="st">"SPY"</span>, <span class="at">signal =</span> <span class="st">"BUY"</span>, <span class="at">exit_date =</span> <span class="fu">as.Date</span>(<span class="st">"2024-12-30"</span>))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>s4_test_performance <span class="ot">&lt;-</span> <span class="fu">run_backtest</span>(s4_test_signals, test_prices, <span class="at">portfolio_alloc =</span> <span class="dv">1</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine performance data for plotting</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co"># s1_test_performance$strategy &lt;- "1_Multiple_Execs"</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>s2_test_performance<span class="sc">$</span>strategy <span class="ot">&lt;-</span> <span class="st">"2_Buy_Sell_Index"</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>s3_test_performance<span class="sc">$</span>strategy <span class="ot">&lt;-</span> <span class="st">"3_Skin_In_Game"</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>s4_test_performance<span class="sc">$</span>strategy <span class="ot">&lt;-</span> <span class="st">"4_SP500_Benchmark"</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>all_performance <span class="ot">&lt;-</span> <span class="fu">rbind</span>(s2_test_performance, s3_test_performance, s4_test_performance)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the portfolio value over time for 2024</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>all_performance <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> portfolio_value, <span class="at">color =</span> strategy)) <span class="sc">+</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Strategy Performance on 2024 Data"</span>,</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Portfolio Value ($)"</span>,</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Strategy"</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar) <span class="sc">+</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="edgar_trading_strategies_files/figure-html/evaluate-performance-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>After all that work, it turns out these strategies don’t perform very well. Just buying and holding an ETF tracking the S&amp;P500 index provides way better returns. There are a number of factors contributing to this poor performance, but two major causes stand out:</p>
<ul>
<li><strong>Infrequent Signals:</strong> Strategy 1 didn’t trigger any entry flags during the test period, so it doesn’t even show up in the final performance evaluation, and even in the training set it only triggered a single entry flag. The other two strategies at least had a few entry flags, but still not that many.</li>
<li><strong>Portfolio Utilization:</strong> Related to the lack of entry flags, the three strategies used naive portfolio weighting to allocate 10% of the portfolio capital to each new position. However, since there were so few entry flags the portfolio capital was never fully invested in any strategy except in the benchmark strategy.</li>
</ul>
<p>At the end of the day, there doesn’t seem to be sufficient data to support these strategies, at least as currently designed. Some ideas for future work could include trying to leverage the sale transaction data (there are significantly more sales than purchases in this dataset) and buy put options, or try to leverage the Form 3 data where one company acquires a 10% or higher ownership stake in another as a factor that could drive up the price for the company being acquired.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>The SEC’s EDGAR database contains many regulatory filings, and this analysis showed how to extract information from a few of them and then leverage that information to create trading strategies. While the final evaluation showed that these particular strategies are not very profitable in their current states, it still lays out a useful framework for acquiring data from the free public EDGAR API and thinking about how to evaluate any subsequent trading strategies.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>